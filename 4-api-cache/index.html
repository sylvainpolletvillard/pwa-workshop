<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>4. Cache Strategy for REST API | PWA Workshop</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="manifest" href="manifest.json">
    <meta name="description" content="Introduction to Progressive Web Applications">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="PWA Workshop Docs">
    <meta name="apple-mobile-web-app-title" content="PWA Workshop Docs">
    
    <link rel="preload" href="/assets/css/0.styles.c9269685.css" as="style"><link rel="preload" href="/assets/js/app.1ff487e6.js" as="script"><link rel="preload" href="/assets/js/2.19469b2b.js" as="script"><link rel="preload" href="/assets/js/1.6f1ef934.js" as="script"><link rel="preload" href="/assets/js/31.cc75035b.js" as="script"><link rel="preload" href="/assets/js/23.4035d5be.js" as="script"><link rel="prefetch" href="/assets/js/10.9ceccfbf.js"><link rel="prefetch" href="/assets/js/11.7c904f5e.js"><link rel="prefetch" href="/assets/js/12.939c0d55.js"><link rel="prefetch" href="/assets/js/13.9e7546d3.js"><link rel="prefetch" href="/assets/js/14.1c1dda77.js"><link rel="prefetch" href="/assets/js/15.c2b36012.js"><link rel="prefetch" href="/assets/js/16.a86399ea.js"><link rel="prefetch" href="/assets/js/17.9aa1c5d4.js"><link rel="prefetch" href="/assets/js/18.76b938b8.js"><link rel="prefetch" href="/assets/js/19.2e6b2533.js"><link rel="prefetch" href="/assets/js/20.82849728.js"><link rel="prefetch" href="/assets/js/21.c61d69ee.js"><link rel="prefetch" href="/assets/js/22.35b66f3d.js"><link rel="prefetch" href="/assets/js/24.c66fd85a.js"><link rel="prefetch" href="/assets/js/25.da49a6e2.js"><link rel="prefetch" href="/assets/js/26.ae78996d.js"><link rel="prefetch" href="/assets/js/27.b4b8b8a1.js"><link rel="prefetch" href="/assets/js/28.81f7352d.js"><link rel="prefetch" href="/assets/js/29.9e8716fb.js"><link rel="prefetch" href="/assets/js/3.3efec36e.js"><link rel="prefetch" href="/assets/js/30.33b8e1d1.js"><link rel="prefetch" href="/assets/js/32.90a77f18.js"><link rel="prefetch" href="/assets/js/33.44cf70fc.js"><link rel="prefetch" href="/assets/js/34.f672da4a.js"><link rel="prefetch" href="/assets/js/35.7d66fc77.js"><link rel="prefetch" href="/assets/js/36.9bc65e11.js"><link rel="prefetch" href="/assets/js/37.e404a38f.js"><link rel="prefetch" href="/assets/js/38.5b3881e8.js"><link rel="prefetch" href="/assets/js/39.df61cee3.js"><link rel="prefetch" href="/assets/js/4.c01b16e6.js"><link rel="prefetch" href="/assets/js/40.7f516925.js"><link rel="prefetch" href="/assets/js/41.976fcaad.js"><link rel="prefetch" href="/assets/js/42.9569119e.js"><link rel="prefetch" href="/assets/js/43.5eb6d74c.js"><link rel="prefetch" href="/assets/js/44.e7d635f3.js"><link rel="prefetch" href="/assets/js/45.50204063.js"><link rel="prefetch" href="/assets/js/46.06ea0baf.js"><link rel="prefetch" href="/assets/js/47.0d61679f.js"><link rel="prefetch" href="/assets/js/48.ba2fc676.js"><link rel="prefetch" href="/assets/js/49.ceab4c78.js"><link rel="prefetch" href="/assets/js/5.85fe764d.js"><link rel="prefetch" href="/assets/js/50.65eed350.js"><link rel="prefetch" href="/assets/js/51.d622cc82.js"><link rel="prefetch" href="/assets/js/52.b3c359b5.js"><link rel="prefetch" href="/assets/js/53.8263a1d3.js"><link rel="prefetch" href="/assets/js/54.a26e999d.js"><link rel="prefetch" href="/assets/js/55.82c04c1a.js"><link rel="prefetch" href="/assets/js/56.82f9414c.js"><link rel="prefetch" href="/assets/js/57.87972581.js"><link rel="prefetch" href="/assets/js/58.19f96269.js"><link rel="prefetch" href="/assets/js/59.19563258.js"><link rel="prefetch" href="/assets/js/6.268c3966.js"><link rel="prefetch" href="/assets/js/60.ae5ff8a9.js"><link rel="prefetch" href="/assets/js/61.54dfee7a.js"><link rel="prefetch" href="/assets/js/62.22d302cb.js"><link rel="prefetch" href="/assets/js/63.398e68fe.js"><link rel="prefetch" href="/assets/js/64.1431b97b.js"><link rel="prefetch" href="/assets/js/65.4908a545.js"><link rel="prefetch" href="/assets/js/66.55927046.js"><link rel="prefetch" href="/assets/js/67.062d51d3.js"><link rel="prefetch" href="/assets/js/68.aade6588.js"><link rel="prefetch" href="/assets/js/69.18d07a09.js"><link rel="prefetch" href="/assets/js/7.35092d36.js"><link rel="prefetch" href="/assets/js/70.68ca6251.js"><link rel="prefetch" href="/assets/js/71.c85f89d8.js"><link rel="prefetch" href="/assets/js/72.82655067.js"><link rel="prefetch" href="/assets/js/73.eede0435.js"><link rel="prefetch" href="/assets/js/74.157cc7aa.js"><link rel="prefetch" href="/assets/js/75.73b66951.js"><link rel="prefetch" href="/assets/js/76.6649bb64.js"><link rel="prefetch" href="/assets/js/77.0fed6726.js"><link rel="prefetch" href="/assets/js/78.29aaa828.js"><link rel="prefetch" href="/assets/js/79.94afd192.js"><link rel="prefetch" href="/assets/js/80.ca638a89.js"><link rel="prefetch" href="/assets/js/81.333ba269.js"><link rel="prefetch" href="/assets/js/82.27169079.js"><link rel="prefetch" href="/assets/js/83.c97456b4.js"><link rel="prefetch" href="/assets/js/84.4a8863b4.js"><link rel="prefetch" href="/assets/js/85.5e1bf0b7.js"><link rel="prefetch" href="/assets/js/86.62118f50.js"><link rel="prefetch" href="/assets/js/87.530b3ac6.js"><link rel="prefetch" href="/assets/js/88.23419234.js"><link rel="prefetch" href="/assets/js/89.86ba6c86.js"><link rel="prefetch" href="/assets/js/90.29dcdad2.js"><link rel="prefetch" href="/assets/js/91.05020850.js"><link rel="prefetch" href="/assets/js/92.d82b22b2.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.f9004e39.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c9269685.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">PWA Workshop</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://pwa-cookbook.js.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Cookbook
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/sylvainpolletvillard/pwa-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Language</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Language</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/4-api-cache/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/fr/4-api-cache/" class="nav-link">
  Français
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://pwa-cookbook.js.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Cookbook
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/sylvainpolletvillard/pwa-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Language</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Language</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/4-api-cache/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/fr/4-api-cache/" class="nav-link">
  Français
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/1-manifest/" class="sidebar-link">1. Adding a Web App Manifest</a></li><li><a href="/2-service-worker/" class="sidebar-link">2. Install a Service Worker</a></li><li><a href="/3-precaching/" class="sidebar-link">3. Precaching and basic offline mode</a></li><li><a href="/4-api-cache/" aria-current="page" class="active sidebar-link">4. Cache Strategy for REST API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/4-api-cache/#cache-update-refresh" class="sidebar-link">Cache, Update, Refresh</a></li><li class="sidebar-sub-header"><a href="/4-api-cache/#implementation" class="sidebar-link">Implementation</a></li><li class="sidebar-sub-header"><a href="/4-api-cache/#refreshing-the-view" class="sidebar-link">Refreshing the view</a></li><li class="sidebar-sub-header"><a href="/4-api-cache/#testing" class="sidebar-link">Testing</a></li></ul></li><li><a href="/5-pwa-install/" class="sidebar-link">5. Install PWA on the device</a></li><li><a href="/6-background-sync/" class="sidebar-link">6. Background sync and notifications</a></li><li><a href="/finish.html" class="sidebar-link">To go further</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="step-4-cache-update-refresh-strategy-for-get-requests-from-the-rest-api"><a href="#step-4-cache-update-refresh-strategy-for-get-requests-from-the-rest-api" class="header-anchor">#</a> Step 4: Cache / Update / Refresh strategy for GET requests from the REST API</h1> <p>We saw in the previous step how to cache static files. The strategy we have put in place for these files is called <em>Cache-First</em>, that is, always return the cached version if available. What about dynamic data, typically API responses?</p> <p>To have an offline mode, we also need to put this data in a local cache. On the other hand, unlike static files, it is important for the user to have the most recent data (the &quot;freshest&quot;) as soon as possible. So we have to change our strategy.</p> <h2 id="cache-update-refresh"><a href="#cache-update-refresh" class="header-anchor">#</a> Cache, Update, Refresh</h2> <p>This cache strategy is slightly more complex but allows the use of the local cache to significantly speed up the first loading time, even if temporarily displaying data that is out of date.</p> <p>For each request, the Worker service will first immediately return a cached response if it exists, and then in parallel query the network. Upon receiving the response from the network, the cached entry will be updated and the user interface will be updated automatically.</p> <p>Refreshing the interface can be done in different ways depending on your use case. You can simply add items dynamically to a list, like messages in an instant conversation for example. Or notify the user in another way, for example with a link proposing to load the new content available.</p> <p><img src="/assets/img/schema.688fdb36.png" alt="Flowsheet"></p> <p>Advantages:</p> <ul><li>Instant load if a response is cached</li> <li>Can improve the user experience</li></ul> <p>Disadvantages:</p> <ul><li>The user must not be able to interact with out-to-date data</li> <li>Refreshing the interface after network response can disturb the user if UX is not well thought out</li></ul> <h2 id="implementation"><a href="#implementation" class="header-anchor">#</a> Implementation</h2> <p>For our application, we will implement this <em>Cache, Update, Refresh</em> strategy to load the list of workshop attendees. This list will probably change a little between each request and most of the successive changes will be the addition of a few attendees. Refreshing the view should therefore be quite natural for the user. This strategy seems to be the most appropriate in this case.</p> <h3 id="choosing-the-right-strategy-depending-on-the-request"><a href="#choosing-the-right-strategy-depending-on-the-request" class="header-anchor">#</a> Choosing the right strategy depending on the request</h3> <p>Let's start again with the Service Worker code in the <code>fetch</code> event callback. We will distinguish requests to our API from requests to static files, in order to apply a different strategy:</p> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;fetch&quot;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;/api/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// response to API requests, Cache Update Refresh strategy</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// response to static files requests, Cache-First strategy</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>All our requests to the API go through the same endpoint containing <code>/api/</code> in the URL. So, we can easily identify these requests based on the URL accessible from <code>event.request.url</code>. Here is the <a href="https://developer.mozilla.org/en-US/docs/Web/API/FetchEvent" target="_blank" rel="noopener noreferrer">FetchEvent API documentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h3 id="_1-cache"><a href="#_1-cache" class="header-anchor">#</a> 1. Cache</h3> <p>The first step is to respond immediately with the cached response if it exists. You can do this by reusing the <code>caches.match</code> function seen in step 3 to respons to static files requests.</p> <details class="hidden" data-v-167f501e><summary data-v-167f501e>See the solution</summary> <div class="language-js extra-class" data-v-167f501e><pre class="language-js" data-v-167f501e><code data-v-167f501e><span class="token keyword" data-v-167f501e>if</span> <span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>.</span>url<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>includes</span><span class="token punctuation" data-v-167f501e>(</span><span class="token string" data-v-167f501e>&quot;/api/&quot;</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token punctuation" data-v-167f501e>{</span>
  <span class="token comment" data-v-167f501e>// response to API requests, Cache Update Refresh strategy</span>
  event<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>respondWith</span><span class="token punctuation" data-v-167f501e>(</span>caches<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>match</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
  <span class="token comment" data-v-167f501e>//TODO: update et refresh</span>
<span class="token punctuation" data-v-167f501e>}</span>
</code></pre></div></details> <h3 id="_2-update"><a href="#_2-update" class="header-anchor">#</a> 2. Update</h3> <p>In parallel, the request to the network also has be made with the <code>fetch(request)</code> method, then we update the cache with the response via the <code>cache.put</code> method. Declare the <code>update</code> function below in the Service Worker code:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
    <span class="token parameter">response</span> <span class="token operator">=&gt;</span>
      <span class="token function">cache</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token comment">// we can put response in cache</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> response<span class="token punctuation">)</span> <span class="token comment">// resolve promise with the Response object</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Then, call this <code>update</code> function in the<code>fetch</code> callback in parallel with the response with the cached version. You can still continue to use the <code>event</code> object in the following code even after a first <code>event.respondWith</code>. However, you will need to use the <code>event.waitUntil()</code> method to extend the life of the event and tell the browser that more work needs to be done beyond the initial response.</p> <details class="hidden" data-v-167f501e><summary data-v-167f501e>See the solution</summary> <div class="language-js extra-class" data-v-167f501e><pre class="language-js" data-v-167f501e><code data-v-167f501e><span class="token keyword" data-v-167f501e>if</span> <span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>.</span>url<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>includes</span><span class="token punctuation" data-v-167f501e>(</span><span class="token string" data-v-167f501e>&quot;/api/&quot;</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token punctuation" data-v-167f501e>{</span>
  <span class="token comment" data-v-167f501e>// response to API requests, Cache Update Refresh strategy</span>
  event<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>respondWith</span><span class="token punctuation" data-v-167f501e>(</span>caches<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>match</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
  event<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>waitUntil</span><span class="token punctuation" data-v-167f501e>(</span><span class="token function" data-v-167f501e>update</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span> <span class="token comment" data-v-167f501e>//TODO: refresh</span>
<span class="token punctuation" data-v-167f501e>}</span>
</code></pre></div></details> <h3 id="_3-refresh"><a href="#_3-refresh" class="header-anchor">#</a> 3. Refresh</h3> <p>If the network has responded and the response has been cached, you want to tell the application that new data is available to refresh the application view.</p> <p>Applications with a registered and installed Service Worker are referred to as &quot;clients&quot; for this Service Worker, and can be accessed through the <a href="https://developer.mozilla.org/en-US/docs/web/API/Clients" target="_blank" rel="noopener noreferrer">Clients API documented here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. The Service Worker communicates with the client through the <code>client.postMessage</code> method. The exchange format is textual, so you will need to serialize your data into JSON. The transmitted message will be an object composed with at least one property to identify the type of message (here we chose the URL of the corresponding request) and another property containing the data to be transmitted (the content of the response).</p> <p>Declare the <code>refresh</code> function below in the Service Worker code.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> response
    <span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// read and parse JSON response</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">jsonResponse</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      self<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">clients</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">client</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// report and send new data to client</span>
          client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>
            <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              <span class="token literal-property property">type</span><span class="token operator">:</span> response<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
              <span class="token literal-property property">data</span><span class="token operator">:</span> jsonResponse<span class="token punctuation">.</span>data
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> jsonResponse<span class="token punctuation">.</span>data<span class="token punctuation">;</span> <span class="token comment">// resolve promise with new data</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>All that remains is to assemble the 3 <code>cache</code>, <code>update</code> and <code>refresh</code> blocks to finalize the strategy: the cache response with <code>event.respondWith</code>, then in parallel the update followed by the refresh in a <code>event.waitUntil</code>. The <code>update</code> function returns a<code>Promise</code> resolved with the network response, so you can chain it with <code>.then()</code> to execute another function after the network response.</p> <details class="hidden" data-v-167f501e><summary data-v-167f501e>See the solution</summary> <div class="language-js extra-class" data-v-167f501e><pre class="language-js" data-v-167f501e><code data-v-167f501e><span class="token keyword" data-v-167f501e>if</span> <span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>.</span>url<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>includes</span><span class="token punctuation" data-v-167f501e>(</span><span class="token string" data-v-167f501e>&quot;/api/&quot;</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token punctuation" data-v-167f501e>{</span>
  <span class="token comment" data-v-167f501e>// response to API requests, Cache Update Refresh strategy</span>
  event<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>respondWith</span><span class="token punctuation" data-v-167f501e>(</span>caches<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>match</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
  event<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>waitUntil</span><span class="token punctuation" data-v-167f501e>(</span><span class="token function" data-v-167f501e>update</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>then</span><span class="token punctuation" data-v-167f501e>(</span>refresh<span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
<span class="token punctuation" data-v-167f501e>}</span>
</code></pre></div></details> <h2 id="refreshing-the-view"><a href="#refreshing-the-view" class="header-anchor">#</a> Refreshing the view</h2> <p>The client can listen to messages emitted by the Service Worker via the <code>navigator.serviceWorker.onmessage</code> callback. Then you can deserialize the message with <code>JSON.parse(event.data)</code>. In <code>scripts.js</code>, once the Service Worker is registered, declare the following callback:</p> <div class="language-js extra-class"><pre class="language-js"><code>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//TODO: detect the type of message and refresh the view</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>The <code>renderAttendees</code> function allows you to update the list of attendees. The view will be updated when the Service Worker sends the message with the new data. Complete the code above, checking if the message is an update of the attendees list, then recall the <code>renderAttendees</code> function with the data received in the message.</p> <details class="hidden" data-v-167f501e><summary data-v-167f501e>See the solution</summary> <div class="language-js extra-class" data-v-167f501e><pre class="language-js" data-v-167f501e><code data-v-167f501e>navigator<span class="token punctuation" data-v-167f501e>.</span>serviceWorker<span class="token punctuation" data-v-167f501e>.</span><span class="token function-variable function" data-v-167f501e>onmessage</span> <span class="token operator" data-v-167f501e>=</span> <span class="token parameter" data-v-167f501e>event</span> <span class="token operator" data-v-167f501e>=&gt;</span> <span class="token punctuation" data-v-167f501e>{</span>
	<span class="token keyword" data-v-167f501e>const</span> message <span class="token operator" data-v-167f501e>=</span> <span class="token constant" data-v-167f501e>JSON</span><span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>parse</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>data<span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
	<span class="token keyword" data-v-167f501e>if</span><span class="token punctuation" data-v-167f501e>(</span>message <span class="token operator" data-v-167f501e>&amp;&amp;</span> message<span class="token punctuation" data-v-167f501e>.</span>type<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>includes</span><span class="token punctuation" data-v-167f501e>(</span><span class="token string" data-v-167f501e>&quot;/api/users&quot;</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>{</span>
		console<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>log</span><span class="token punctuation" data-v-167f501e>(</span><span class="token string" data-v-167f501e>&quot;List of attendees to date&quot;</span><span class="token punctuation" data-v-167f501e>,</span> message<span class="token punctuation" data-v-167f501e>.</span>data<span class="token punctuation" data-v-167f501e>)</span>
		<span class="token function" data-v-167f501e>renderAttendees</span><span class="token punctuation" data-v-167f501e>(</span>message<span class="token punctuation" data-v-167f501e>.</span>data<span class="token punctuation" data-v-167f501e>)</span>
	<span class="token punctuation" data-v-167f501e>}</span>
<span class="token punctuation" data-v-167f501e>}</span>
</code></pre></div></details> <h2 id="testing"><a href="#testing" class="header-anchor">#</a> Testing</h2> <p>To test if the loading strategy works properly, since the application currently uses a mockup API with false data, we will simulate changes in the number of attendees and add a false network latency to give us the time to observe the strategy in action.</p> <p>Change the <code>update</code> function in<code>sw.js</code> like this:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">delay</span> <span class="token operator">=</span> <span class="token parameter">ms</span> <span class="token operator">=&gt;</span> <span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// mockup: load randomly between 1 and 10 attendees</span>
	<span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">?per_page=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// add a fake latency of 3 seconds</span>
	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
</code></pre></div><p>Make sure the Service Worker is up-to-date and reinstalled (in the Developer Tools, Application&gt; Service Workers tab, check the <em>Update on reload</em> check box, see step 2), then reload the page. You should see the old number of attendees, then 3 seconds later the list will refresh with a new number of attendees.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/3-precaching/" class="prev">
        3. Precaching and basic offline mode
      </a></span> <span class="next"><a href="/5-pwa-install/">
        5. Install PWA on the device
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1ff487e6.js" defer></script><script src="/assets/js/2.19469b2b.js" defer></script><script src="/assets/js/1.6f1ef934.js" defer></script><script src="/assets/js/31.cc75035b.js" defer></script><script src="/assets/js/23.4035d5be.js" defer></script>
  </body>
</html>
