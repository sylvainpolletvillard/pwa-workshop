<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>3. Precaching and basic offline mode | PWA Workshop</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="manifest" href="manifest.json">
    <meta name="description" content="Introduction to Progressive Web Applications">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="PWA Workshop Docs">
    <meta name="apple-mobile-web-app-title" content="PWA Workshop Docs">
    
    <link rel="preload" href="/assets/css/0.styles.c9269685.css" as="style"><link rel="preload" href="/assets/js/app.1ff487e6.js" as="script"><link rel="preload" href="/assets/js/2.19469b2b.js" as="script"><link rel="preload" href="/assets/js/1.6f1ef934.js" as="script"><link rel="preload" href="/assets/js/26.ae78996d.js" as="script"><link rel="preload" href="/assets/js/23.4035d5be.js" as="script"><link rel="prefetch" href="/assets/js/10.9ceccfbf.js"><link rel="prefetch" href="/assets/js/11.7c904f5e.js"><link rel="prefetch" href="/assets/js/12.939c0d55.js"><link rel="prefetch" href="/assets/js/13.9e7546d3.js"><link rel="prefetch" href="/assets/js/14.1c1dda77.js"><link rel="prefetch" href="/assets/js/15.c2b36012.js"><link rel="prefetch" href="/assets/js/16.a86399ea.js"><link rel="prefetch" href="/assets/js/17.9aa1c5d4.js"><link rel="prefetch" href="/assets/js/18.76b938b8.js"><link rel="prefetch" href="/assets/js/19.2e6b2533.js"><link rel="prefetch" href="/assets/js/20.82849728.js"><link rel="prefetch" href="/assets/js/21.c61d69ee.js"><link rel="prefetch" href="/assets/js/22.35b66f3d.js"><link rel="prefetch" href="/assets/js/24.c66fd85a.js"><link rel="prefetch" href="/assets/js/25.da49a6e2.js"><link rel="prefetch" href="/assets/js/27.b4b8b8a1.js"><link rel="prefetch" href="/assets/js/28.81f7352d.js"><link rel="prefetch" href="/assets/js/29.9e8716fb.js"><link rel="prefetch" href="/assets/js/3.3efec36e.js"><link rel="prefetch" href="/assets/js/30.33b8e1d1.js"><link rel="prefetch" href="/assets/js/31.cc75035b.js"><link rel="prefetch" href="/assets/js/32.90a77f18.js"><link rel="prefetch" href="/assets/js/33.44cf70fc.js"><link rel="prefetch" href="/assets/js/34.f672da4a.js"><link rel="prefetch" href="/assets/js/35.7d66fc77.js"><link rel="prefetch" href="/assets/js/36.9bc65e11.js"><link rel="prefetch" href="/assets/js/37.e404a38f.js"><link rel="prefetch" href="/assets/js/38.5b3881e8.js"><link rel="prefetch" href="/assets/js/39.df61cee3.js"><link rel="prefetch" href="/assets/js/4.c01b16e6.js"><link rel="prefetch" href="/assets/js/40.7f516925.js"><link rel="prefetch" href="/assets/js/41.976fcaad.js"><link rel="prefetch" href="/assets/js/42.9569119e.js"><link rel="prefetch" href="/assets/js/43.5eb6d74c.js"><link rel="prefetch" href="/assets/js/44.e7d635f3.js"><link rel="prefetch" href="/assets/js/45.50204063.js"><link rel="prefetch" href="/assets/js/46.06ea0baf.js"><link rel="prefetch" href="/assets/js/47.0d61679f.js"><link rel="prefetch" href="/assets/js/48.ba2fc676.js"><link rel="prefetch" href="/assets/js/49.ceab4c78.js"><link rel="prefetch" href="/assets/js/5.85fe764d.js"><link rel="prefetch" href="/assets/js/50.65eed350.js"><link rel="prefetch" href="/assets/js/51.d622cc82.js"><link rel="prefetch" href="/assets/js/52.b3c359b5.js"><link rel="prefetch" href="/assets/js/53.8263a1d3.js"><link rel="prefetch" href="/assets/js/54.a26e999d.js"><link rel="prefetch" href="/assets/js/55.82c04c1a.js"><link rel="prefetch" href="/assets/js/56.82f9414c.js"><link rel="prefetch" href="/assets/js/57.87972581.js"><link rel="prefetch" href="/assets/js/58.19f96269.js"><link rel="prefetch" href="/assets/js/59.19563258.js"><link rel="prefetch" href="/assets/js/6.268c3966.js"><link rel="prefetch" href="/assets/js/60.ae5ff8a9.js"><link rel="prefetch" href="/assets/js/61.54dfee7a.js"><link rel="prefetch" href="/assets/js/62.22d302cb.js"><link rel="prefetch" href="/assets/js/63.398e68fe.js"><link rel="prefetch" href="/assets/js/64.1431b97b.js"><link rel="prefetch" href="/assets/js/65.4908a545.js"><link rel="prefetch" href="/assets/js/66.55927046.js"><link rel="prefetch" href="/assets/js/67.062d51d3.js"><link rel="prefetch" href="/assets/js/68.aade6588.js"><link rel="prefetch" href="/assets/js/69.18d07a09.js"><link rel="prefetch" href="/assets/js/7.35092d36.js"><link rel="prefetch" href="/assets/js/70.68ca6251.js"><link rel="prefetch" href="/assets/js/71.c85f89d8.js"><link rel="prefetch" href="/assets/js/72.82655067.js"><link rel="prefetch" href="/assets/js/73.eede0435.js"><link rel="prefetch" href="/assets/js/74.157cc7aa.js"><link rel="prefetch" href="/assets/js/75.73b66951.js"><link rel="prefetch" href="/assets/js/76.6649bb64.js"><link rel="prefetch" href="/assets/js/77.0fed6726.js"><link rel="prefetch" href="/assets/js/78.29aaa828.js"><link rel="prefetch" href="/assets/js/79.94afd192.js"><link rel="prefetch" href="/assets/js/80.ca638a89.js"><link rel="prefetch" href="/assets/js/81.333ba269.js"><link rel="prefetch" href="/assets/js/82.27169079.js"><link rel="prefetch" href="/assets/js/83.c97456b4.js"><link rel="prefetch" href="/assets/js/84.4a8863b4.js"><link rel="prefetch" href="/assets/js/85.5e1bf0b7.js"><link rel="prefetch" href="/assets/js/86.62118f50.js"><link rel="prefetch" href="/assets/js/87.530b3ac6.js"><link rel="prefetch" href="/assets/js/88.23419234.js"><link rel="prefetch" href="/assets/js/89.86ba6c86.js"><link rel="prefetch" href="/assets/js/90.29dcdad2.js"><link rel="prefetch" href="/assets/js/91.05020850.js"><link rel="prefetch" href="/assets/js/92.d82b22b2.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.f9004e39.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c9269685.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">PWA Workshop</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://pwa-cookbook.js.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Cookbook
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/sylvainpolletvillard/pwa-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Language</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Language</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/3-precaching/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/fr/3-precaching/" class="nav-link">
  Français
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://pwa-cookbook.js.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Cookbook
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/sylvainpolletvillard/pwa-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Language</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Language</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/3-precaching/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/fr/3-precaching/" class="nav-link">
  Français
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/1-manifest/" class="sidebar-link">1. Adding a Web App Manifest</a></li><li><a href="/2-service-worker/" class="sidebar-link">2. Install a Service Worker</a></li><li><a href="/3-precaching/" aria-current="page" class="active sidebar-link">3. Precaching and basic offline mode</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/3-precaching/#preamble-promises-and-async-await" class="sidebar-link">Preamble: Promises and async/await</a></li><li class="sidebar-sub-header"><a href="/3-precaching/#exploring-caching-apis" class="sidebar-link">Exploring caching APIs</a></li><li class="sidebar-sub-header"><a href="/3-precaching/#precaching-critical-static-files" class="sidebar-link">Precaching critical static files</a></li><li class="sidebar-sub-header"><a href="/3-precaching/#response-with-cache-in-priority" class="sidebar-link">Response with cache in priority</a></li><li class="sidebar-sub-header"><a href="/3-precaching/#testing-offline" class="sidebar-link">Testing offline</a></li><li class="sidebar-sub-header"><a href="/3-precaching/#put-files-in-cache-automatically" class="sidebar-link">Put files in cache automatically</a></li><li class="sidebar-sub-header"><a href="/3-precaching/#cache-updates" class="sidebar-link">Cache updates</a></li></ul></li><li><a href="/4-api-cache/" class="sidebar-link">4. Cache Strategy for REST API</a></li><li><a href="/5-pwa-install/" class="sidebar-link">5. Install PWA on the device</a></li><li><a href="/6-background-sync/" class="sidebar-link">6. Background sync and notifications</a></li><li><a href="/finish.html" class="sidebar-link">To go further</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="step-3-precaching-static-assets-for-a-basic-offline-mode"><a href="#step-3-precaching-static-assets-for-a-basic-offline-mode" class="header-anchor">#</a> Step 3: Precaching static assets for a basic offline mode</h1> <p>We saw in the previous step two methods of the Service Worker life cycle: <code>install</code> and<code>activate</code>. In this part, we will continue our exploration of PWA by caching static files.</p> <h2 id="preamble-promises-and-async-await"><a href="#preamble-promises-and-async-await" class="header-anchor">#</a> Preamble: Promises and async/await</h2> <p>Service worker APIs rely heavily on promises. Let's take a quick look on how they work.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>You can try the code in your browser JS console or in an online editor like <a href="https://repl.it/languages/javascript" target="_blank" rel="noopener noreferrer">repl.it<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <p>Promises provide an interface to handle series of asynchronous function calls more conveniently. They improve code readability compared to callbacks passed as arguments, for example. A Promise is an object that represents the result of an asynchronous operation. It can be in one of three states:</p> <ul><li>pending: the operation is not yet completed</li> <li>fulfilled: the operation is completed successfully</li> <li>rejected: the operation failed</li></ul> <p>Once we have a <code>Promise</code> object, its associated code already started to execute asynchronously. We can use the <code>then()</code> and <code>reject()</code> functions to execute a function when the promises succeeds or fails (it calls. Most of the Service worker APIs provide asynchronous functions that return a Promise. For example, the <code>fetch()</code> function is used to make a network request and returns a promise that resolves with a <code>Response</code> object when the request succeeds or rejects with an error when the request fails:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;http://server.api/user/yassine&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
promise
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">userData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// this function is called when the request is successful</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>userData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// this function is called when the request failed for any reason</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Promise example&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// this log is shown before the other two because the promise is asynchronous</span>
</code></pre></div><p>The best feature of Promises is that they can be easily chained. Inside a <code>then</code> callback, you can pass a function that returns another Promise in order to chain asynchronous operations:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">initDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>fetchAllUsers<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">users</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fetchUser</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>handleFailure<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// if any of the previous calls fails, catch is called</span>
</code></pre></div><p>Since ES2018 specification, there is a new operator that can be used to deal with promises with a more <em>synchronous</em> style. Instead of chaining <code>then</code> calls and callbacks, we can pause the function execution while waiting for a promise result, then store the result in a variable and resume function execution. This is called awaiting the result and uses the <code>async/await</code> keywords. With this method, the <code>catch</code> method is replaced by a <code>try/catch</code> block, just like you are used to catch synchronous exceptions.</p> <p>The following code snippet transforms the last example to use <code>async/await</code>.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// If we want to use await, we must be place the code in async function</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">mainAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// wait for promise result without blocking the thread</span>
    <span class="token keyword">await</span> <span class="token function">initDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchAllUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchUser</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// this catch block is executed if any promise above fails</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">mainAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// call the function that runs async code</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Promise example with async / await&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>This concludes this overview about promises and async/await.
With this knowledge acquired, we can use the caching APIs of the service worker more serenely.</p> <p><em>If you still feel uncomfortable with promises, here are some exercices: <a href="https://github.com/asakusuma/promise-workshop" target="_blank" rel="noopener noreferrer">set 1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://repl.it/@AdamCahan/Promise-practice-exercises" target="_blank" rel="noopener noreferrer">set 2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://developers.google.com/web/ilt/pwa/lab-promises" target="_blank" rel="noopener noreferrer">set 3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></em></p> <h2 id="exploring-caching-apis"><a href="#exploring-caching-apis" class="header-anchor">#</a> Exploring caching APIs</h2> <p>Of the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API" target="_blank" rel="noopener noreferrer">APIs that the Service Worker has access to<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, the one we are interested in is <a href="https://developer.mozilla.org/en-US/docs/Web/API/Cache" target="_blank" rel="noopener noreferrer">Cache API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Indeed, it makes it possible to put in a persistent cache the requests/responses pairs with the method <code>cache.put(request, response)</code>. It is also possible to pass one or more URLs as arguments to the <code>cache.add</code> and <code>cache.addAll</code> methods; they will be requested and the network response will be added to the cache. You can also delete cache entries with the <code>cache.delete</code> method.</p> <p>The different caches are accessible through the <code>caches</code> variable from the Service Worker. It is the <a href="https://developer.mozilla.org/en-US/docs/Web/API/CacheStorage" target="_blank" rel="noopener noreferrer">CacheStorage API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> which allows, among other things, to create / retrieve a cache object or to delete one with the <code>caches.open</code> and <code>caches.delete</code> functions.</p> <p>Finally, another interesting method of the cache is <code>match</code>: it checks in all <code>Cache</code> objects managed by the <code>CacheStorage</code> if a request is identical to that passed in parameter. If so, it returns a Promise resolved with the cached response.</p> <h2 id="precaching-critical-static-files"><a href="#precaching-critical-static-files" class="header-anchor">#</a> Precaching critical static files</h2> <p>We will cache the essential static files of the application as soon as possible. The best timing to do this is when the <code>install</code> event is triggered, because it is only called once at Service Worker installation. This is called <em>precaching</em>.</p> <ol><li>Go to <code>sw.js</code> in the <code>install</code> event callback as seen in step 2.</li> <li>Open the cache with <a href="https://developer.mozilla.org/en-US/docs/Web/API/CacheStorage/open" target="_blank" rel="noopener noreferrer"><code>caches.open('V1')</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, which returns a Promise resolved with the <code>cache</code> object. The version number in the cache name will be useful for future updates.</li> <li>Once the cache is open, add to the cache with <a href="https://developer.mozilla.org/en-US/docs/Web/API/Cache/addAll" target="_blank" rel="noopener noreferrer"><code>cache.addAll(['url1', 'url2', ...])</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. the URLs to the essential static files of our application: the root HTML page, the <code>styles.css</code> file and the<code>scripts.js</code> file.</li> <li>In order for the Service Worker to activate after precaching is complete, pass the <code>Promise</code> returned by <code>cache.addAll</code> as an argument to <a href="https://developer.mozilla.org/en-US/docs/Web/API/ExtendableEvent/waitUntil" target="_blank" rel="noopener noreferrer"><code>event.waitUntil ()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <code>event</code> being the installation event.</li></ol> <details class="hidden" data-v-167f501e><summary data-v-167f501e>See the solution</summary> <div class="language-js extra-class" data-v-167f501e><pre class="language-js" data-v-167f501e><code data-v-167f501e><span class="token keyword" data-v-167f501e>const</span> <span class="token constant" data-v-167f501e>CACHE_NAME</span> <span class="token operator" data-v-167f501e>=</span> <span class="token string" data-v-167f501e>&quot;V1&quot;</span><span class="token punctuation" data-v-167f501e>;</span>
<span class="token keyword" data-v-167f501e>const</span> <span class="token constant" data-v-167f501e>STATIC_CACHE_URLS</span> <span class="token operator" data-v-167f501e>=</span> <span class="token punctuation" data-v-167f501e>[</span><span class="token string" data-v-167f501e>&quot;/&quot;</span><span class="token punctuation" data-v-167f501e>,</span> <span class="token string" data-v-167f501e>&quot;styles.css&quot;</span><span class="token punctuation" data-v-167f501e>,</span> <span class="token string" data-v-167f501e>&quot;scripts.js&quot;</span><span class="token punctuation" data-v-167f501e>]</span><span class="token punctuation" data-v-167f501e>;</span>

self<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>addEventListener</span><span class="token punctuation" data-v-167f501e>(</span><span class="token string" data-v-167f501e>&quot;install&quot;</span><span class="token punctuation" data-v-167f501e>,</span> <span class="token punctuation" data-v-167f501e>(</span><span class="token parameter" data-v-167f501e>event</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token operator" data-v-167f501e>=&gt;</span> <span class="token punctuation" data-v-167f501e>{</span>
  console<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>log</span><span class="token punctuation" data-v-167f501e>(</span><span class="token string" data-v-167f501e>&quot;Service Worker installing.&quot;</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
  event<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>waitUntil</span><span class="token punctuation" data-v-167f501e>(</span>
    caches<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>open</span><span class="token punctuation" data-v-167f501e>(</span><span class="token constant" data-v-167f501e>CACHE_NAME</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>then</span><span class="token punctuation" data-v-167f501e>(</span><span class="token punctuation" data-v-167f501e>(</span><span class="token parameter" data-v-167f501e>cache</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token operator" data-v-167f501e>=&gt;</span> cache<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>addAll</span><span class="token punctuation" data-v-167f501e>(</span><span class="token constant" data-v-167f501e>STATIC_CACHE_URLS</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span>
  <span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
<span class="token punctuation" data-v-167f501e>}</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
</code></pre></div></details> <p>Reload the page and the Service Worker, making sure that the new version of the Service Worker replaces the old one as seen in step 2. We can then check that the files are added to the cache by looking at the <em>Cache Storage section</em> in the <em>Application</em> tab of Chrome Developer Tools.</p> <p><img src="/assets/img/cache_storage.04f1ba9e.png" alt="Cache storage"></p> <h2 id="response-with-cache-in-priority"><a href="#response-with-cache-in-priority" class="header-anchor">#</a> Response with cache in priority</h2> <p>Now that the files are cached, we have to indicate to use their cached version when the browser requests them. To do this, we will use the <code>fetch</code> event. The latter intercepts all requests made by clients who have installed the Service Worker. You can then return a custom response with <code>event.respondWith</code>, where <code>event</code> is the <a href="https://developer.mozilla.org/en-US/docs/Web/API/FetchEvent" target="_blank" rel="noopener noreferrer">FetchEvent<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. The <a href="https://developer.mozilla.org/en-US/docs/Web/API/FetchEvent/respondWith" target="_blank" rel="noopener noreferrer"><code>event.respondWith</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> function takes as a single argument a Promise that must be resolved with the response to return.</p> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;fetch&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Request of </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// default behaviour: request the network</span>
  event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>We want to change the default behavior and return previously cached versions if they exist. Precisely, the <a href="https://developer.mozilla.org/en-US/docs/Web/API/CacheStorage/match" target="_blank" rel="noopener noreferrer"><code>caches.match</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> function returns a Promise resolved with a<code>Response</code> object, just like <code>fetch (event.request)</code>. So we can replace one by the other and return the static files from cache instead of requesting them from the network.</p> <ol><li>Add a callback for the <code>fetch</code> event, the same way you did for<code>install</code> in the previous step.</li> <li>Call the <code>caches.match(event.request)</code> method to search the cache for a cached response for the corresponding request.</li> <li>If no cache entry is found, the Promise is resolved with the value <code>undefined</code>. In this case, you need to request the network and return <code>fetch(event.request)</code> instead.</li> <li>Finally, return this Promise of Response to the client request by passing it as argument to <code>event.respondWith()</code></li></ol> <details class="hidden" data-v-167f501e><summary data-v-167f501e>See the solution</summary> <div class="language-js extra-class" data-v-167f501e><pre class="language-js" data-v-167f501e><code data-v-167f501e>self<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>addEventListener</span><span class="token punctuation" data-v-167f501e>(</span><span class="token string" data-v-167f501e>&quot;fetch&quot;</span><span class="token punctuation" data-v-167f501e>,</span> <span class="token punctuation" data-v-167f501e>(</span><span class="token parameter" data-v-167f501e>event</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token operator" data-v-167f501e>=&gt;</span> <span class="token punctuation" data-v-167f501e>{</span>
  <span class="token comment" data-v-167f501e>// Cache-First Strategy</span>
  event<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>respondWith</span><span class="token punctuation" data-v-167f501e>(</span>
    caches
      <span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>match</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>)</span> <span class="token comment" data-v-167f501e>// check if the request has already been cached</span>
      <span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>then</span><span class="token punctuation" data-v-167f501e>(</span><span class="token punctuation" data-v-167f501e>(</span><span class="token parameter" data-v-167f501e>cached</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token operator" data-v-167f501e>=&gt;</span> cached <span class="token operator" data-v-167f501e>||</span> <span class="token function" data-v-167f501e>fetch</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token comment" data-v-167f501e>// otherwise request network</span>
  <span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
<span class="token punctuation" data-v-167f501e>}</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
</code></pre></div></details> <h2 id="testing-offline"><a href="#testing-offline" class="header-anchor">#</a> Testing offline</h2> <p>If everything has been done correctly, you should now be able to test the application in offline mode. Shut down your local server and try to reload the application. The cached page should be displayed.</p> <h2 id="put-files-in-cache-automatically"><a href="#put-files-in-cache-automatically" class="header-anchor">#</a> Put files in cache automatically</h2> <p>When offline, some non-essential static files can not be downloaded and have not been put in cache ; for example, the PWA logo in the header. Let's change our service worker code to put these files in cache automatically, without using precaching at install.</p> <ol><li>Add this <code>cache</code> function below in the Service Worker code:</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">cache</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;error&quot;</span> <span class="token operator">||</span> response<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;opaque&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// do not put in cache network errors</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> caches
    <span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">CACHE_NAME</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">Warning</p> <p>An answer can only be read once, so it must be cloned with the <code>.clone()</code> method before caching it.</p></div> <ol start="2"><li><p>In <code>fetch</code> event callback, add another <code>then</code> instruction after fetching network, then call the function <code>cache</code> declared before with the request and its response to put them in cache.</p></li> <li><p>Add one last <code>then</code> instruction to make sure the promise resolves with the network response as final value, as required by the <code>event.respondWith</code> function.</p></li></ol> <details class="hidden" data-v-167f501e><summary data-v-167f501e>See the solution</summary> <div class="language-js extra-class" data-v-167f501e><pre class="language-js" data-v-167f501e><code data-v-167f501e>self<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>addEventListener</span><span class="token punctuation" data-v-167f501e>(</span><span class="token string" data-v-167f501e>&quot;fetch&quot;</span><span class="token punctuation" data-v-167f501e>,</span> <span class="token punctuation" data-v-167f501e>(</span><span class="token parameter" data-v-167f501e>event</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token operator" data-v-167f501e>=&gt;</span> <span class="token punctuation" data-v-167f501e>{</span>
  <span class="token comment" data-v-167f501e>// Cache-First Strategy</span>
  event<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>respondWith</span><span class="token punctuation" data-v-167f501e>(</span>
    caches
      <span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>match</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>)</span> <span class="token comment" data-v-167f501e>// check if the request has already been cached</span>
      <span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>then</span><span class="token punctuation" data-v-167f501e>(</span><span class="token punctuation" data-v-167f501e>(</span><span class="token parameter" data-v-167f501e>cached</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token operator" data-v-167f501e>=&gt;</span> cached <span class="token operator" data-v-167f501e>||</span> <span class="token function" data-v-167f501e>fetch</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token comment" data-v-167f501e>// otherwise request network</span>
      <span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>then</span><span class="token punctuation" data-v-167f501e>(</span>
        <span class="token punctuation" data-v-167f501e>(</span><span class="token parameter" data-v-167f501e>response</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token operator" data-v-167f501e>=&gt;</span>
          <span class="token function" data-v-167f501e>cache</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>,</span> response<span class="token punctuation" data-v-167f501e>)</span> <span class="token comment" data-v-167f501e>// put response in cache</span>
            <span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>then</span><span class="token punctuation" data-v-167f501e>(</span><span class="token punctuation" data-v-167f501e>(</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token operator" data-v-167f501e>=&gt;</span> response<span class="token punctuation" data-v-167f501e>)</span> <span class="token comment" data-v-167f501e>// resolve promise with the network response</span>
      <span class="token punctuation" data-v-167f501e>)</span>
  <span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
<span class="token punctuation" data-v-167f501e>}</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
</code></pre></div></details> <p>To test automatic cache, go back online and reload the app to put in cache the PWA logo. Check with the <em>DevTools</em> that it is correctly added to the cache, then go back offline and try to load this logo without any Internet connection.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Files loaded from an external domain that does not allow CORS requests, like the attendees pictures taken from Amazon and the font taken from Google, cannot be put in cache like the other static files. You will have to host these files on your domain or configure CORS on the external domain to be allowed to cache those.</p></div> <h2 id="cache-updates"><a href="#cache-updates" class="header-anchor">#</a> Cache updates</h2> <p>Caching static files raises a question: what happens if I add, delete, or modify these files on the server ?</p> <p>As we have currently coded our Service Worker, we will always load the cached files, so new versions deployed on the server will never be used.</p> <p>To handle this problem, one solution is to use a new cache with another name. The idea here would be to create a new <strong>V2</strong> cache that contains the new files and remove the previous obsolete cache.</p> <ol><li>In the <code>install</code> event callback, change the cache name to<code>V2</code></li> <li>In the <code>activate</code> event callback, delete the old cache with <code>caches.delete('V1')</code></li> <li>Pass the <code>Promise</code> returned by<code>caches.delete</code> in <code>event.waitUntil</code> in order to wait for the cache to be removed before the end of the activation step</li> <li><em>(optional)</em> - Improve your cache cleanup code by removing all caches that are not in your whitelist of used caches. You can browse all existing caches with the <code>caches.keys()</code> method</li></ol> <details class="hidden" data-v-167f501e><summary data-v-167f501e>See the solution</summary> <div class="language-js extra-class" data-v-167f501e><pre class="language-js" data-v-167f501e><code data-v-167f501e><span class="token keyword" data-v-167f501e>const</span> <span class="token constant" data-v-167f501e>CACHE_NAME</span> <span class="token operator" data-v-167f501e>=</span> <span class="token string" data-v-167f501e>&quot;V2&quot;</span><span class="token punctuation" data-v-167f501e>;</span>

self<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>addEventListener</span><span class="token punctuation" data-v-167f501e>(</span><span class="token string" data-v-167f501e>&quot;activate&quot;</span><span class="token punctuation" data-v-167f501e>,</span> <span class="token punctuation" data-v-167f501e>(</span><span class="token parameter" data-v-167f501e>event</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token operator" data-v-167f501e>=&gt;</span> <span class="token punctuation" data-v-167f501e>{</span>
  <span class="token comment" data-v-167f501e>// delete any unexpected caches</span>
  event<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>waitUntil</span><span class="token punctuation" data-v-167f501e>(</span>
    caches
      <span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>keys</span><span class="token punctuation" data-v-167f501e>(</span><span class="token punctuation" data-v-167f501e>)</span>
      <span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>then</span><span class="token punctuation" data-v-167f501e>(</span><span class="token punctuation" data-v-167f501e>(</span><span class="token parameter" data-v-167f501e>keys</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token operator" data-v-167f501e>=&gt;</span> keys<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>filter</span><span class="token punctuation" data-v-167f501e>(</span><span class="token punctuation" data-v-167f501e>(</span><span class="token parameter" data-v-167f501e>key</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token operator" data-v-167f501e>=&gt;</span> key <span class="token operator" data-v-167f501e>!==</span> <span class="token constant" data-v-167f501e>CACHE_NAME</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span>
      <span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>then</span><span class="token punctuation" data-v-167f501e>(</span><span class="token punctuation" data-v-167f501e>(</span><span class="token parameter" data-v-167f501e>keys</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token operator" data-v-167f501e>=&gt;</span>
        Promise<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>all</span><span class="token punctuation" data-v-167f501e>(</span>
          keys<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>map</span><span class="token punctuation" data-v-167f501e>(</span><span class="token punctuation" data-v-167f501e>(</span><span class="token parameter" data-v-167f501e>key</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token operator" data-v-167f501e>=&gt;</span> <span class="token punctuation" data-v-167f501e>{</span>
            console<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>log</span><span class="token punctuation" data-v-167f501e>(</span><span class="token template-string" data-v-167f501e><span class="token template-punctuation string" data-v-167f501e>`</span><span class="token string" data-v-167f501e>Deleting cache </span><span class="token interpolation" data-v-167f501e><span class="token interpolation-punctuation punctuation" data-v-167f501e>${</span>key<span class="token interpolation-punctuation punctuation" data-v-167f501e>}</span></span><span class="token template-punctuation string" data-v-167f501e>`</span></span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
            <span class="token keyword" data-v-167f501e>return</span> caches<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>delete</span><span class="token punctuation" data-v-167f501e>(</span>key<span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
          <span class="token punctuation" data-v-167f501e>}</span><span class="token punctuation" data-v-167f501e>)</span>
        <span class="token punctuation" data-v-167f501e>)</span>
      <span class="token punctuation" data-v-167f501e>)</span>
  <span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
<span class="token punctuation" data-v-167f501e>}</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
</code></pre></div></details> <p><img src="/assets/img/schema.f921f8d6.png" alt="Flowsheet"></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/2-service-worker/" class="prev">
        2. Install a Service Worker
      </a></span> <span class="next"><a href="/4-api-cache/">
        4. Cache Strategy for REST API
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1ff487e6.js" defer></script><script src="/assets/js/2.19469b2b.js" defer></script><script src="/assets/js/1.6f1ef934.js" defer></script><script src="/assets/js/26.ae78996d.js" defer></script><script src="/assets/js/23.4035d5be.js" defer></script>
  </body>
</html>
