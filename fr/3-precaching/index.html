<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>3. Precaching et mode offline basique | PWA Workshop</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="manifest" href="manifest.json">
    <meta name="description" content="Introduction aux Progressive Web Applications">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="PWA Workshop Docs">
    <meta name="apple-mobile-web-app-title" content="PWA Workshop Docs">
    
    <link rel="preload" href="/assets/css/0.styles.c9269685.css" as="style"><link rel="preload" href="/assets/js/app.1ff487e6.js" as="script"><link rel="preload" href="/assets/js/2.19469b2b.js" as="script"><link rel="preload" href="/assets/js/1.6f1ef934.js" as="script"><link rel="preload" href="/assets/js/27.b4b8b8a1.js" as="script"><link rel="preload" href="/assets/js/23.4035d5be.js" as="script"><link rel="prefetch" href="/assets/js/10.9ceccfbf.js"><link rel="prefetch" href="/assets/js/11.7c904f5e.js"><link rel="prefetch" href="/assets/js/12.939c0d55.js"><link rel="prefetch" href="/assets/js/13.9e7546d3.js"><link rel="prefetch" href="/assets/js/14.1c1dda77.js"><link rel="prefetch" href="/assets/js/15.c2b36012.js"><link rel="prefetch" href="/assets/js/16.a86399ea.js"><link rel="prefetch" href="/assets/js/17.9aa1c5d4.js"><link rel="prefetch" href="/assets/js/18.76b938b8.js"><link rel="prefetch" href="/assets/js/19.2e6b2533.js"><link rel="prefetch" href="/assets/js/20.82849728.js"><link rel="prefetch" href="/assets/js/21.c61d69ee.js"><link rel="prefetch" href="/assets/js/22.35b66f3d.js"><link rel="prefetch" href="/assets/js/24.c66fd85a.js"><link rel="prefetch" href="/assets/js/25.da49a6e2.js"><link rel="prefetch" href="/assets/js/26.ae78996d.js"><link rel="prefetch" href="/assets/js/28.81f7352d.js"><link rel="prefetch" href="/assets/js/29.9e8716fb.js"><link rel="prefetch" href="/assets/js/3.3efec36e.js"><link rel="prefetch" href="/assets/js/30.33b8e1d1.js"><link rel="prefetch" href="/assets/js/31.cc75035b.js"><link rel="prefetch" href="/assets/js/32.90a77f18.js"><link rel="prefetch" href="/assets/js/33.44cf70fc.js"><link rel="prefetch" href="/assets/js/34.f672da4a.js"><link rel="prefetch" href="/assets/js/35.7d66fc77.js"><link rel="prefetch" href="/assets/js/36.9bc65e11.js"><link rel="prefetch" href="/assets/js/37.e404a38f.js"><link rel="prefetch" href="/assets/js/38.5b3881e8.js"><link rel="prefetch" href="/assets/js/39.df61cee3.js"><link rel="prefetch" href="/assets/js/4.c01b16e6.js"><link rel="prefetch" href="/assets/js/40.7f516925.js"><link rel="prefetch" href="/assets/js/41.976fcaad.js"><link rel="prefetch" href="/assets/js/42.9569119e.js"><link rel="prefetch" href="/assets/js/43.5eb6d74c.js"><link rel="prefetch" href="/assets/js/44.e7d635f3.js"><link rel="prefetch" href="/assets/js/45.50204063.js"><link rel="prefetch" href="/assets/js/46.06ea0baf.js"><link rel="prefetch" href="/assets/js/47.0d61679f.js"><link rel="prefetch" href="/assets/js/48.ba2fc676.js"><link rel="prefetch" href="/assets/js/49.ceab4c78.js"><link rel="prefetch" href="/assets/js/5.85fe764d.js"><link rel="prefetch" href="/assets/js/50.65eed350.js"><link rel="prefetch" href="/assets/js/51.d622cc82.js"><link rel="prefetch" href="/assets/js/52.b3c359b5.js"><link rel="prefetch" href="/assets/js/53.8263a1d3.js"><link rel="prefetch" href="/assets/js/54.a26e999d.js"><link rel="prefetch" href="/assets/js/55.82c04c1a.js"><link rel="prefetch" href="/assets/js/56.82f9414c.js"><link rel="prefetch" href="/assets/js/57.87972581.js"><link rel="prefetch" href="/assets/js/58.19f96269.js"><link rel="prefetch" href="/assets/js/59.19563258.js"><link rel="prefetch" href="/assets/js/6.268c3966.js"><link rel="prefetch" href="/assets/js/60.ae5ff8a9.js"><link rel="prefetch" href="/assets/js/61.54dfee7a.js"><link rel="prefetch" href="/assets/js/62.22d302cb.js"><link rel="prefetch" href="/assets/js/63.398e68fe.js"><link rel="prefetch" href="/assets/js/64.1431b97b.js"><link rel="prefetch" href="/assets/js/65.4908a545.js"><link rel="prefetch" href="/assets/js/66.55927046.js"><link rel="prefetch" href="/assets/js/67.062d51d3.js"><link rel="prefetch" href="/assets/js/68.aade6588.js"><link rel="prefetch" href="/assets/js/69.18d07a09.js"><link rel="prefetch" href="/assets/js/7.35092d36.js"><link rel="prefetch" href="/assets/js/70.68ca6251.js"><link rel="prefetch" href="/assets/js/71.c85f89d8.js"><link rel="prefetch" href="/assets/js/72.82655067.js"><link rel="prefetch" href="/assets/js/73.eede0435.js"><link rel="prefetch" href="/assets/js/74.157cc7aa.js"><link rel="prefetch" href="/assets/js/75.73b66951.js"><link rel="prefetch" href="/assets/js/76.6649bb64.js"><link rel="prefetch" href="/assets/js/77.0fed6726.js"><link rel="prefetch" href="/assets/js/78.29aaa828.js"><link rel="prefetch" href="/assets/js/79.94afd192.js"><link rel="prefetch" href="/assets/js/80.ca638a89.js"><link rel="prefetch" href="/assets/js/81.333ba269.js"><link rel="prefetch" href="/assets/js/82.27169079.js"><link rel="prefetch" href="/assets/js/83.c97456b4.js"><link rel="prefetch" href="/assets/js/84.4a8863b4.js"><link rel="prefetch" href="/assets/js/85.5e1bf0b7.js"><link rel="prefetch" href="/assets/js/86.62118f50.js"><link rel="prefetch" href="/assets/js/87.530b3ac6.js"><link rel="prefetch" href="/assets/js/88.23419234.js"><link rel="prefetch" href="/assets/js/89.86ba6c86.js"><link rel="prefetch" href="/assets/js/90.29dcdad2.js"><link rel="prefetch" href="/assets/js/91.05020850.js"><link rel="prefetch" href="/assets/js/92.d82b22b2.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.f9004e39.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c9269685.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fr/" class="home-link router-link-active"><!----> <span class="site-name">PWA Workshop</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://pwa-cookbook.js.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Cookbook
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/sylvainpolletvillard/pwa-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Langue</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Langue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/3-precaching/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/fr/3-precaching/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Français
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://pwa-cookbook.js.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Cookbook
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/sylvainpolletvillard/pwa-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Langue</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Langue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/3-precaching/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/fr/3-precaching/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Français
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/fr/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/fr/1-manifest/" class="sidebar-link">1. Ajout d'un Web App Manifest</a></li><li><a href="/fr/2-service-worker/" class="sidebar-link">2. Installation d'un Service Worker</a></li><li><a href="/fr/3-precaching/" aria-current="page" class="active sidebar-link">3. Precaching et mode offline basique</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fr/3-precaching/#preambule-utilisation-des-promesses-et-async-wait" class="sidebar-link">Préambule: Utilisation des promesses et async / wait</a></li><li class="sidebar-sub-header"><a href="/fr/3-precaching/#decouverte-des-api-de-mise-en-cache" class="sidebar-link">Découverte des API de mise en cache</a></li><li class="sidebar-sub-header"><a href="/fr/3-precaching/#precaching-des-fichiers-statiques-critiques" class="sidebar-link">Precaching des fichiers statiques critiques</a></li><li class="sidebar-sub-header"><a href="/fr/3-precaching/#reponse-avec-le-cache-en-priorite" class="sidebar-link">Réponse avec le cache en priorité</a></li><li class="sidebar-sub-header"><a href="/fr/3-precaching/#test-de-fonctionnement-offline" class="sidebar-link">Test de fonctionnement offline</a></li><li class="sidebar-sub-header"><a href="/fr/3-precaching/#mise-en-cache-automatique" class="sidebar-link">Mise en cache automatique</a></li><li class="sidebar-sub-header"><a href="/fr/3-precaching/#mises-a-jour-du-cache" class="sidebar-link">Mises à jour du cache</a></li></ul></li><li><a href="/fr/4-api-cache/" class="sidebar-link">4. Stratégie de Cache pour API REST</a></li><li><a href="/fr/5-pwa-install/" class="sidebar-link">5. Installation d'une PWA sur le système</a></li><li><a href="/fr/6-background-sync/" class="sidebar-link">6. Background sync et notifications</a></li><li><a href="/fr/finish.html" class="sidebar-link">Pour aller plus loin</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="etape-3-precaching-des-assets-statiques-pour-un-mode-offline-basique"><a href="#etape-3-precaching-des-assets-statiques-pour-un-mode-offline-basique" class="header-anchor">#</a> Etape 3 : Precaching des assets statiques pour un mode offline basique</h1> <p>On a vu dans l'étape précédent deux méthodes du cycle de vie d'un Service Worker: <code>install</code> et <code>activate</code>. Dans cette partie, on va poursuivre notre exploration des PWA en mettant en cache les fichiers statiques.</p> <h2 id="preambule-utilisation-des-promesses-et-async-wait"><a href="#preambule-utilisation-des-promesses-et-async-wait" class="header-anchor">#</a> Préambule: Utilisation des promesses et async / wait</h2> <p>Les API de Service Worker utilisent majoritairement une fonctionnalité de JavaScript appelée les promesses (<code>Promise</code>). Jetons un coup d'œil sur leur fonctionnement.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Vous pouvez essayer le code de cette section en utilisant la console JavaScript de votre navigateur  ou un éditeur en ligne tel que <a href="https://repl.it/languages/nodejs" target="_blank" rel="noopener noreferrer">https://repl.it<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <p>Les promesses sont une interface standardisée permettant de gérer plus facilement les appels en série de fonctions asynchrones. Elles améliorent la lisibilité du code et sont plus pratiques à manipuler par le développeur que des fonctions de retour (<em>callbacks</em>) passées en argument par exemple. Elles sont disponibles nativement depuis ES2015. Une promesse est un objet qui représente la promesse d'un résultat d'une opération asynchrone. Une promesse peut être dans l'un des trois états suivants:</p> <ul><li><strong>pending</strong>: l'opération asynchrone est en cours d'exécution</li> <li><strong>fulfilled</strong>: l'opération asynchrone a réussi</li> <li><strong>rejected</strong>: l'opération asynchrone a échoué</li></ul> <p>Une fois que nous avons un objet <code>Promise</code>, son code associé a déjà commencé à s'exécuter de manière asynchrone. Nous pouvons utiliser les fonctions <code>then()</code> et <code>reject()</code> pour déclarer une fonction à exécuter lorsque la promesse réussit ou échoue. La plupart des API des Service Workers fournissent des fonctions asynchrones qui retournent une promesse. Par exemple, la fonction <code>fetch ()</code> est utilisée pour faire une requête réseau et retourne une promesse qui se résout avec un objet <code>Response</code> lorsque la requête a réussie, ou est rejetée avec une erreur lorsque la requête a échoué pour une quelconque raison :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;http://server.api/user/yassine&quot;</span><span class="token punctuation">)</span>
promise
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">userData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// this function is called when the request is successful</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>userData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// this function is called when the request failed for any reason</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Promise example&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// this log is shown before the other two because the promise is asynchronous</span>
</code></pre></div><p>L'intérêt principal des promesses est qu'elles peuvent être facilement chaînées. Dans un callback passe à <code>then()</code>, vous pouvez retourner une autre promesse afin de chaîner plusieurs opérations asynchrones:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">initDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>fetchAllUsers<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">users</span> <span class="token operator">=&gt;</span> <span class="token function">fetchUser</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>handleFailure<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// if any of the previous calls fails, catch is called</span>
</code></pre></div><p>Depuis la spécification ES2018, il existe un nouvel opérateur permettant de gérer les promesses dans un style plus <em>synchrone</em>.
Au lieu d'enchainer les appels de <code>then</code>, on peut mettre en pause l'exécution d'une fonction en attendant le résultat d'une promesse, puis stocker ce résultat dans une variable et reprendre l'exécution de la fonction.</p> <p>Ceci est appelé <em>une attente du résultat</em> ou <strong>await</strong> et se fait en utilisant les mots-clés <code>async / await</code>. Avec cette méthode, la méthode <code>catch</code> est remplacée par un bloc <code>try / catch</code>, tout comme on gère habituellement les exceptions synchrones.</p> <p>L'extrait de code suivant transforme le dernier exemple en utilisant <code>async / wait</code>:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Pour pouvoir utiliser await, il faut que la fonction soit déclarée avec le mot-clé async</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">mainAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// attend le résultat de la promesse sans bloquer le thread</span>
    <span class="token keyword">await</span> <span class="token function">initDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchAllUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchUser</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ce bloc catch est exécuté si l'une des promesses ci-dessus échoue</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">mainAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// call the function that runs async code</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Promise example with async / await&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Ceci conclut cet aperçu sur les promesses et async/wait.</p> <p><em>Voici en bonus quelques exercices supplémentaires: <a href="https://github.com/asakusuma/promise-workshop" target="_blank" rel="noopener noreferrer">série 1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://repl.it/@AdamCahan/Promise-practice-exercises" target="_blank" rel="noopener noreferrer">série 2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> et <a href="https://developers.google.com/web/ilt/pwa/lab-promises" target="_blank" rel="noopener noreferrer">série 3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></em></p> <h2 id="decouverte-des-api-de-mise-en-cache"><a href="#decouverte-des-api-de-mise-en-cache" class="header-anchor">#</a> Découverte des API de mise en cache</h2> <p>Parmi les <a href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API" target="_blank" rel="noopener noreferrer">API auquel a accès le Service Worker<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, celle qui nous intéresse le plus est <a href="https://developer.mozilla.org/en-US/docs/Web/API/Cache" target="_blank" rel="noopener noreferrer">l'API Cache<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. En effet, elle permet de mettre dans un cache persistant les paires Requêtes/Réponses réseau via la méthode <code>cache.put(request, response)</code>. Il est également possible de passer une ou plusieurs URL en argument des méthodes <code>add</code> et <code>addAll</code> ; elles seront requêtées et la réponse sera ajoutée au cache. On peut également supprimer des entrées du cache avec la méthode <code>delete</code>.</p> <p>Les différents caches sont accessibles via la variable <code>caches</code> depuis le Service Worker. C'est l'API <a href="https://developer.mozilla.org/en-US/docs/Web/API/CacheStorage" target="_blank" rel="noopener noreferrer">CacheStorage<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> qui permet, entre autres, de créer/obtenir un objet cache ou d'en supprimer un avec les fonctions <code>open</code> et <code>delete</code>.</p> <p>Enfin, une autre méthode intéressante du cache est <code>match</code>: elle vérifie dans les tous les objets <code>Cache</code> gérés par le <code>CacheStorage</code> si une requête est identique à celle passée en paramètre. Si c'est le cas, elle retourne un promesse qui permet d'accéder à la réponse en cache.</p> <h2 id="precaching-des-fichiers-statiques-critiques"><a href="#precaching-des-fichiers-statiques-critiques" class="header-anchor">#</a> Precaching des fichiers statiques critiques</h2> <p>Nous allons mettre en cache les fichiers statiques essentiels de l'application, et ce le plus tôt possible. Le moment opportun pour cela est l'évènement <code>install</code> du Service Worker, car il n'est appelé qu'une fois lors de son installation. C'est ce qu'on appelle le <em>precaching</em>.</p> <ol><li>Placez-vous dans <code>sw.js</code> dans le callback de l'événement <code>install</code> vu à l'étape 2.</li> <li>Ouvrez le cache avec <a href="https://developer.mozilla.org/en-US/docs/Web/API/CacheStorage/open" target="_blank" rel="noopener noreferrer"><code>caches.open('V1')</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, qui retourne une promesse résolue avec l'objet <code>cache</code>. Le numéro de version dans le nom du cache nous sera utile pour les mises à jour ultérieures.</li> <li>Une fois le cache ouvert, ajoutez au cache avec <a href="https://developer.mozilla.org/en-US/docs/Web/API/Cache/addAll" target="_blank" rel="noopener noreferrer"><code>cache.addAll(['url1','url2',...])</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> les URL vers les fichiers statiques essentiels de notre application: la page HTML racine, le fichier <code>styles.css</code> et le fichier <code>scripts.js</code>.</li> <li>Afin que le Service Worker s'active une fois le precaching terminé, passez la <code>Promise</code> retournée par <code>cache.addAll</code> en argument à <a href="https://developer.mozilla.org/en-US/docs/Web/API/ExtendableEvent/waitUntil" target="_blank" rel="noopener noreferrer"><code>event.waitUntil()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <code>event</code> étant l'évènement d'installation.</li></ol> <details class="hidden" data-v-167f501e><summary data-v-167f501e>Voir la solution</summary> <div class="language-js extra-class" data-v-167f501e><pre class="language-js" data-v-167f501e><code data-v-167f501e><span class="token keyword" data-v-167f501e>const</span> <span class="token constant" data-v-167f501e>CACHE_NAME</span> <span class="token operator" data-v-167f501e>=</span> <span class="token string" data-v-167f501e>&quot;V1&quot;</span><span class="token punctuation" data-v-167f501e>;</span>
<span class="token keyword" data-v-167f501e>const</span> <span class="token constant" data-v-167f501e>STATIC_CACHE_URLS</span> <span class="token operator" data-v-167f501e>=</span> <span class="token punctuation" data-v-167f501e>[</span><span class="token string" data-v-167f501e>&quot;/&quot;</span><span class="token punctuation" data-v-167f501e>,</span> <span class="token string" data-v-167f501e>&quot;styles.css&quot;</span><span class="token punctuation" data-v-167f501e>,</span> <span class="token string" data-v-167f501e>&quot;scripts.js&quot;</span><span class="token punctuation" data-v-167f501e>]</span><span class="token punctuation" data-v-167f501e>;</span>

self<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>addEventListener</span><span class="token punctuation" data-v-167f501e>(</span><span class="token string" data-v-167f501e>&quot;install&quot;</span><span class="token punctuation" data-v-167f501e>,</span> <span class="token parameter" data-v-167f501e>event</span> <span class="token operator" data-v-167f501e>=&gt;</span> <span class="token punctuation" data-v-167f501e>{</span>
  console<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>log</span><span class="token punctuation" data-v-167f501e>(</span><span class="token string" data-v-167f501e>&quot;Service Worker installing.&quot;</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
  event<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>waitUntil</span><span class="token punctuation" data-v-167f501e>(</span>
    caches<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>open</span><span class="token punctuation" data-v-167f501e>(</span><span class="token constant" data-v-167f501e>CACHE_NAME</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>then</span><span class="token punctuation" data-v-167f501e>(</span><span class="token parameter" data-v-167f501e>cache</span> <span class="token operator" data-v-167f501e>=&gt;</span> cache<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>addAll</span><span class="token punctuation" data-v-167f501e>(</span><span class="token constant" data-v-167f501e>STATIC_CACHE_URLS</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span>
  <span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
<span class="token punctuation" data-v-167f501e>}</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
</code></pre></div></details> <p>Rechargez la page et le Service Worker, en vérifiant bien que la nouvelle version du Service Worker remplace l'ancienne comme vu à l'étape 2. On peut alors vérifier que les fichiers sont ajoutés dans le cache en consultant l'écran <em>Cache Storage</em> de l'onglet <em>Application</em> des Developer Tools.</p> <p><img src="/assets/img/cache_storage.04f1ba9e.png" alt="Cache storage"></p> <h2 id="reponse-avec-le-cache-en-priorite"><a href="#reponse-avec-le-cache-en-priorite" class="header-anchor">#</a> Réponse avec le cache en priorité</h2> <p>Maintenant que les fichiers sont en cache, il nous reste à indiquer d'utiliser leur version en cache lorsque le navigateur les demande. Pour ce faire, nous allons passer par l'évènement <code>fetch</code>. Ce dernier intercepte tous les appels émis par les clients ayant installé le Service Worker. On peut alors retourner une réponse personnalisée avec <code>event.respondWith</code>, où <code>event</code> est le <a href="https://developer.mozilla.org/en-US/docs/Web/API/FetchEvent" target="_blank" rel="noopener noreferrer">FetchEvent<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. La fonction <a href="https://developer.mozilla.org/en-US/docs/Web/API/FetchEvent/respondWith" target="_blank" rel="noopener noreferrer"><code>event.respondWith</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> prend comme unique argument une promesse qui devra être résolue avec la réponse à retourner.</p> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;fetch&quot;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Request of </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// comportement par défaut: requête le réseau</span>
  event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Nous voulons changer le comportement par défaut et retourner les versions préalablement mises en cache si elles existent. Justement, la fonction <a href="https://developer.mozilla.org/en-US/docs/Web/API/CacheStorage/match" target="_blank" rel="noopener noreferrer"><code>caches.match</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> retourne une promesse résolue avec un objet <code>Response</code>, tout comme <code>fetch(event.request)</code>. On peut donc remplacer l'un par l'autre pour retourner les fichiers statiques en cache au lieu d'aller les chercher sur le réseau.</p> <ol><li>Ajoutez un callback pour l'événement <code>fetch</code>, de la même façon que vous l'avez fait pour <code>install</code> à l'étape précédente.</li> <li>Appelez la méthode <code>caches.match(event.request)</code> pour chercher dans le cache une éventuelle réponse mise en cache pour la requête correspondante.</li> <li>Si aucune entrée dans le cache n'est trouvée, la promesse est résolue avec la valeur <code>undefined</code>. Dans ce cas, il faut requêter le réseau et retourner <code>fetch(event.request)</code> à la place.</li> <li>Il ne reste plus qu'à retourner cette promesse de réponse à la requête en la passant en argument à <code>event.respondWith()</code></li></ol> <details class="hidden" data-v-167f501e><summary data-v-167f501e>Voir la solution</summary> <div class="language-js extra-class" data-v-167f501e><pre class="language-js" data-v-167f501e><code data-v-167f501e>self<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>addEventListener</span><span class="token punctuation" data-v-167f501e>(</span><span class="token string" data-v-167f501e>&quot;fetch&quot;</span><span class="token punctuation" data-v-167f501e>,</span> <span class="token parameter" data-v-167f501e>event</span> <span class="token operator" data-v-167f501e>=&gt;</span> <span class="token punctuation" data-v-167f501e>{</span>
  <span class="token comment" data-v-167f501e>// Stratégie Cache-First</span>
  event<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>respondWith</span><span class="token punctuation" data-v-167f501e>(</span>
    caches
      <span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>match</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>)</span> <span class="token comment" data-v-167f501e>// On vérifie si la requête a déjà été mise en cache</span>
      <span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>then</span><span class="token punctuation" data-v-167f501e>(</span><span class="token parameter" data-v-167f501e>cached</span> <span class="token operator" data-v-167f501e>=&gt;</span> cached <span class="token operator" data-v-167f501e>||</span> <span class="token function" data-v-167f501e>fetch</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token comment" data-v-167f501e>// sinon on requête le réseau</span>
  <span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
<span class="token punctuation" data-v-167f501e>}</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
</code></pre></div></details> <h2 id="test-de-fonctionnement-offline"><a href="#test-de-fonctionnement-offline" class="header-anchor">#</a> Test de fonctionnement offline</h2> <p>Si tout a été fait correctement, vous devriez désormais pouvoir tester l'application en mode offline. Coupez votre serveur local et essayez de recharger l'application. La page en cache devrait alors s'afficher.</p> <h2 id="mise-en-cache-automatique"><a href="#mise-en-cache-automatique" class="header-anchor">#</a> Mise en cache automatique</h2> <p>En mode offline, certains fichiers statiques non indispensables ne peuvent plus être téléchargés et n'ont pas été mis en cache. C'est le cas du logo PWA dans la bannière par exemple. Faisons en sorte que ces fichiers soient automatiquement mis en cache, sans être préchargés à l'installation du Service Worker.</p> <ol><li>Ajouter la fonction <code>cache</code> ci-dessous dans le code du Service Worker:</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">cache</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;error&quot;</span> <span class="token operator">||</span> response<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;opaque&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// do not put in cache network errors</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> caches
    <span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">CACHE_NAME</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">cache</span> <span class="token operator">=&gt;</span> cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">Attention</p> <p>Une réponse ne peut être lue qu'une seule fois, elle doit donc être clonée avec la méthode <code>.clone()</code> avant de la stocker en cache.</p></div> <ol start="2"><li><p>Dans le callback de l'événement <code>fetch</code>, ajouter une instruction <code>then</code> à la suite de la requête réseau, puis appelez la fonction <code>cache</code> déclarée précédemment avec la requête et sa réponse pour l'ajouter au cache.</p></li> <li><p>Ajouter une dernière instruction <code>then</code> à la suite pour vous assurer que la promesse retourne bien la réponse réseau comme valeur finale, comme le requiert la fonction <code>event.respondWith</code>.</p></li></ol> <details class="hidden" data-v-167f501e><summary data-v-167f501e>Voir la solution</summary> <div class="language-js extra-class" data-v-167f501e><pre class="language-js" data-v-167f501e><code data-v-167f501e>self<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>addEventListener</span><span class="token punctuation" data-v-167f501e>(</span><span class="token string" data-v-167f501e>&quot;fetch&quot;</span><span class="token punctuation" data-v-167f501e>,</span> <span class="token parameter" data-v-167f501e>event</span> <span class="token operator" data-v-167f501e>=&gt;</span> <span class="token punctuation" data-v-167f501e>{</span>
  <span class="token comment" data-v-167f501e>// Stratégie Cache-First</span>
  event<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>respondWith</span><span class="token punctuation" data-v-167f501e>(</span>
    caches
      <span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>match</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>)</span> <span class="token comment" data-v-167f501e>// On vérifie si la requête a déjà été mise en cache</span>
      <span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>then</span><span class="token punctuation" data-v-167f501e>(</span><span class="token parameter" data-v-167f501e>cached</span> <span class="token operator" data-v-167f501e>=&gt;</span> cached <span class="token operator" data-v-167f501e>||</span> <span class="token function" data-v-167f501e>fetch</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token comment" data-v-167f501e>// sinon on requête le réseau</span>
      <span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>then</span><span class="token punctuation" data-v-167f501e>(</span>
        <span class="token parameter" data-v-167f501e>response</span> <span class="token operator" data-v-167f501e>=&gt;</span>
          <span class="token function" data-v-167f501e>cache</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>,</span> response<span class="token punctuation" data-v-167f501e>)</span> <span class="token comment" data-v-167f501e>// on met à jour le cache</span>
            <span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>then</span><span class="token punctuation" data-v-167f501e>(</span><span class="token punctuation" data-v-167f501e>(</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token operator" data-v-167f501e>=&gt;</span> response<span class="token punctuation" data-v-167f501e>)</span> <span class="token comment" data-v-167f501e>// et on résout la promesse avec l'objet Response</span>
      <span class="token punctuation" data-v-167f501e>)</span>
  <span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
<span class="token punctuation" data-v-167f501e>}</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
</code></pre></div></details> <p>Pour tester la mise en cache automatique, repassez en ligne et rechargez l'application pour mettre en cache le logo PWA. Vérifiez via les <em>DevTools</em> qu'il a bien été ajoutée au cache, puis repassez en mode offline et essayez de le charger sans connexion Internet.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Les fichiers provenant d'un domaine externe n'acceptant pas les requêtes CORS, comme les photos des participants qui viennent de Amazon et la police d'écriture qui vient de Google, ne peuvent pas être mises en cache comme les autres fichiers statiques. Vous devrez les héberger vous-même ou configurer CORS sur le domaine externe afin d'être autorisé à les mettre en cache.</p></div> <h2 id="mises-a-jour-du-cache"><a href="#mises-a-jour-du-cache" class="header-anchor">#</a> Mises à jour du cache</h2> <p>La mise en cache des fichiers statiques pose un problème; que se passe-t-il si j'ajoute, supprime, ou modifie ces fichiers sur le serveur ?</p> <p>Tel que nous avons codé actuellement notre Service Worker, on rechargera toujours les fichiers en cache, donc les nouvelles versions déployées sur le serveur ne seront jamais utilisées.</p> <p>Pour gérer ce problème, une solution est de passer par un nouveau cache avec un autre nom. L'idée ici serait de créer un nouveau cache <strong>V2</strong> qui contient les nouveaux fichiers et de supprimer l'ancien cache.</p> <p><img src="/assets/img/schema.f921f8d6.png" alt="Schéma de fonctionnement"></p> <ol><li>Dans le callback de l'événement <code>install</code>, changez le nom du cache en <code>V2</code></li> <li>Dans le callback de l'événement <code>activate</code>, supprimez l'ancien cache avec <code>caches.delete('V1')</code></li> <li>Passez la <code>Promise</code> retournée par <code>caches.delete</code> dans <code>event.waitUntil</code> afin d'attendre la suppression du cache avant la fin de l'étape d'activation</li> <li><em>(facultatif)</em> - Améliorez votre code de nettoyage des anciens caches en supprimant tous les caches qui ne font pas partie de votre liste de caches connus et utilisés. Vous pouvez parcourir tous les caches existants avec la méthode <code>caches.keys()</code></li></ol> <details class="hidden" data-v-167f501e><summary data-v-167f501e>Voir la solution</summary> <div class="language-js extra-class" data-v-167f501e><pre class="language-js" data-v-167f501e><code data-v-167f501e><span class="token keyword" data-v-167f501e>const</span> <span class="token constant" data-v-167f501e>CACHE_NAME</span> <span class="token operator" data-v-167f501e>=</span> <span class="token string" data-v-167f501e>&quot;V2&quot;</span><span class="token punctuation" data-v-167f501e>;</span>

self<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>addEventListener</span><span class="token punctuation" data-v-167f501e>(</span><span class="token string" data-v-167f501e>&quot;activate&quot;</span><span class="token punctuation" data-v-167f501e>,</span> <span class="token parameter" data-v-167f501e>event</span> <span class="token operator" data-v-167f501e>=&gt;</span> <span class="token punctuation" data-v-167f501e>{</span>
  <span class="token comment" data-v-167f501e>// delete any unexpected caches</span>
  event<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>waitUntil</span><span class="token punctuation" data-v-167f501e>(</span>
    caches
      <span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>keys</span><span class="token punctuation" data-v-167f501e>(</span><span class="token punctuation" data-v-167f501e>)</span>
      <span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>then</span><span class="token punctuation" data-v-167f501e>(</span><span class="token parameter" data-v-167f501e>keys</span> <span class="token operator" data-v-167f501e>=&gt;</span> keys<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>filter</span><span class="token punctuation" data-v-167f501e>(</span><span class="token parameter" data-v-167f501e>key</span> <span class="token operator" data-v-167f501e>=&gt;</span> key <span class="token operator" data-v-167f501e>!==</span> <span class="token constant" data-v-167f501e>CACHE_NAME</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span>
      <span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>then</span><span class="token punctuation" data-v-167f501e>(</span><span class="token parameter" data-v-167f501e>keys</span> <span class="token operator" data-v-167f501e>=&gt;</span>
        Promise<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>all</span><span class="token punctuation" data-v-167f501e>(</span>
          keys<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>map</span><span class="token punctuation" data-v-167f501e>(</span><span class="token parameter" data-v-167f501e>key</span> <span class="token operator" data-v-167f501e>=&gt;</span> <span class="token punctuation" data-v-167f501e>{</span>
            console<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>log</span><span class="token punctuation" data-v-167f501e>(</span><span class="token template-string" data-v-167f501e><span class="token template-punctuation string" data-v-167f501e>`</span><span class="token string" data-v-167f501e>Deleting cache </span><span class="token interpolation" data-v-167f501e><span class="token interpolation-punctuation punctuation" data-v-167f501e>${</span>key<span class="token interpolation-punctuation punctuation" data-v-167f501e>}</span></span><span class="token template-punctuation string" data-v-167f501e>`</span></span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
            <span class="token keyword" data-v-167f501e>return</span> caches<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>delete</span><span class="token punctuation" data-v-167f501e>(</span>key<span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
          <span class="token punctuation" data-v-167f501e>}</span><span class="token punctuation" data-v-167f501e>)</span>
        <span class="token punctuation" data-v-167f501e>)</span>
      <span class="token punctuation" data-v-167f501e>)</span>
  <span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
<span class="token punctuation" data-v-167f501e>}</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
</code></pre></div></details></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fr/2-service-worker/" class="prev">
        2. Installation d'un Service Worker
      </a></span> <span class="next"><a href="/fr/4-api-cache/">
        4. Stratégie de Cache pour API REST
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1ff487e6.js" defer></script><script src="/assets/js/2.19469b2b.js" defer></script><script src="/assets/js/1.6f1ef934.js" defer></script><script src="/assets/js/27.b4b8b8a1.js" defer></script><script src="/assets/js/23.4035d5be.js" defer></script>
  </body>
</html>
