<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>4. Stratégie de Cache pour API REST | PWA Workshop</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="manifest" href="manifest.json">
    <meta name="description" content="Introduction aux Progressive Web Applications">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="PWA Workshop Docs">
    <meta name="apple-mobile-web-app-title" content="PWA Workshop Docs">
    
    <link rel="preload" href="/assets/css/0.styles.c9269685.css" as="style"><link rel="preload" href="/assets/js/app.1ff487e6.js" as="script"><link rel="preload" href="/assets/js/2.19469b2b.js" as="script"><link rel="preload" href="/assets/js/1.6f1ef934.js" as="script"><link rel="preload" href="/assets/js/34.f672da4a.js" as="script"><link rel="preload" href="/assets/js/23.4035d5be.js" as="script"><link rel="prefetch" href="/assets/js/10.9ceccfbf.js"><link rel="prefetch" href="/assets/js/11.7c904f5e.js"><link rel="prefetch" href="/assets/js/12.939c0d55.js"><link rel="prefetch" href="/assets/js/13.9e7546d3.js"><link rel="prefetch" href="/assets/js/14.1c1dda77.js"><link rel="prefetch" href="/assets/js/15.c2b36012.js"><link rel="prefetch" href="/assets/js/16.a86399ea.js"><link rel="prefetch" href="/assets/js/17.9aa1c5d4.js"><link rel="prefetch" href="/assets/js/18.76b938b8.js"><link rel="prefetch" href="/assets/js/19.2e6b2533.js"><link rel="prefetch" href="/assets/js/20.82849728.js"><link rel="prefetch" href="/assets/js/21.c61d69ee.js"><link rel="prefetch" href="/assets/js/22.35b66f3d.js"><link rel="prefetch" href="/assets/js/24.c66fd85a.js"><link rel="prefetch" href="/assets/js/25.da49a6e2.js"><link rel="prefetch" href="/assets/js/26.ae78996d.js"><link rel="prefetch" href="/assets/js/27.b4b8b8a1.js"><link rel="prefetch" href="/assets/js/28.81f7352d.js"><link rel="prefetch" href="/assets/js/29.9e8716fb.js"><link rel="prefetch" href="/assets/js/3.3efec36e.js"><link rel="prefetch" href="/assets/js/30.33b8e1d1.js"><link rel="prefetch" href="/assets/js/31.cc75035b.js"><link rel="prefetch" href="/assets/js/32.90a77f18.js"><link rel="prefetch" href="/assets/js/33.44cf70fc.js"><link rel="prefetch" href="/assets/js/35.7d66fc77.js"><link rel="prefetch" href="/assets/js/36.9bc65e11.js"><link rel="prefetch" href="/assets/js/37.e404a38f.js"><link rel="prefetch" href="/assets/js/38.5b3881e8.js"><link rel="prefetch" href="/assets/js/39.df61cee3.js"><link rel="prefetch" href="/assets/js/4.c01b16e6.js"><link rel="prefetch" href="/assets/js/40.7f516925.js"><link rel="prefetch" href="/assets/js/41.976fcaad.js"><link rel="prefetch" href="/assets/js/42.9569119e.js"><link rel="prefetch" href="/assets/js/43.5eb6d74c.js"><link rel="prefetch" href="/assets/js/44.e7d635f3.js"><link rel="prefetch" href="/assets/js/45.50204063.js"><link rel="prefetch" href="/assets/js/46.06ea0baf.js"><link rel="prefetch" href="/assets/js/47.0d61679f.js"><link rel="prefetch" href="/assets/js/48.ba2fc676.js"><link rel="prefetch" href="/assets/js/49.ceab4c78.js"><link rel="prefetch" href="/assets/js/5.85fe764d.js"><link rel="prefetch" href="/assets/js/50.65eed350.js"><link rel="prefetch" href="/assets/js/51.d622cc82.js"><link rel="prefetch" href="/assets/js/52.b3c359b5.js"><link rel="prefetch" href="/assets/js/53.8263a1d3.js"><link rel="prefetch" href="/assets/js/54.a26e999d.js"><link rel="prefetch" href="/assets/js/55.82c04c1a.js"><link rel="prefetch" href="/assets/js/56.82f9414c.js"><link rel="prefetch" href="/assets/js/57.87972581.js"><link rel="prefetch" href="/assets/js/58.19f96269.js"><link rel="prefetch" href="/assets/js/59.19563258.js"><link rel="prefetch" href="/assets/js/6.268c3966.js"><link rel="prefetch" href="/assets/js/60.ae5ff8a9.js"><link rel="prefetch" href="/assets/js/61.54dfee7a.js"><link rel="prefetch" href="/assets/js/62.22d302cb.js"><link rel="prefetch" href="/assets/js/63.398e68fe.js"><link rel="prefetch" href="/assets/js/64.1431b97b.js"><link rel="prefetch" href="/assets/js/65.4908a545.js"><link rel="prefetch" href="/assets/js/66.55927046.js"><link rel="prefetch" href="/assets/js/67.062d51d3.js"><link rel="prefetch" href="/assets/js/68.aade6588.js"><link rel="prefetch" href="/assets/js/69.18d07a09.js"><link rel="prefetch" href="/assets/js/7.35092d36.js"><link rel="prefetch" href="/assets/js/70.68ca6251.js"><link rel="prefetch" href="/assets/js/71.c85f89d8.js"><link rel="prefetch" href="/assets/js/72.82655067.js"><link rel="prefetch" href="/assets/js/73.eede0435.js"><link rel="prefetch" href="/assets/js/74.157cc7aa.js"><link rel="prefetch" href="/assets/js/75.73b66951.js"><link rel="prefetch" href="/assets/js/76.6649bb64.js"><link rel="prefetch" href="/assets/js/77.0fed6726.js"><link rel="prefetch" href="/assets/js/78.29aaa828.js"><link rel="prefetch" href="/assets/js/79.94afd192.js"><link rel="prefetch" href="/assets/js/80.ca638a89.js"><link rel="prefetch" href="/assets/js/81.333ba269.js"><link rel="prefetch" href="/assets/js/82.27169079.js"><link rel="prefetch" href="/assets/js/83.c97456b4.js"><link rel="prefetch" href="/assets/js/84.4a8863b4.js"><link rel="prefetch" href="/assets/js/85.5e1bf0b7.js"><link rel="prefetch" href="/assets/js/86.62118f50.js"><link rel="prefetch" href="/assets/js/87.530b3ac6.js"><link rel="prefetch" href="/assets/js/88.23419234.js"><link rel="prefetch" href="/assets/js/89.86ba6c86.js"><link rel="prefetch" href="/assets/js/90.29dcdad2.js"><link rel="prefetch" href="/assets/js/91.05020850.js"><link rel="prefetch" href="/assets/js/92.d82b22b2.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.f9004e39.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c9269685.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fr/" class="home-link router-link-active"><!----> <span class="site-name">PWA Workshop</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://pwa-cookbook.js.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Cookbook
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/sylvainpolletvillard/pwa-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Langue</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Langue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/4-api-cache/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/fr/4-api-cache/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Français
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://pwa-cookbook.js.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Cookbook
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/sylvainpolletvillard/pwa-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Langue</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Langue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/4-api-cache/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/fr/4-api-cache/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Français
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/fr/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/fr/1-manifest/" class="sidebar-link">1. Ajout d'un Web App Manifest</a></li><li><a href="/fr/2-service-worker/" class="sidebar-link">2. Installation d'un Service Worker</a></li><li><a href="/fr/3-precaching/" class="sidebar-link">3. Precaching et mode offline basique</a></li><li><a href="/fr/4-api-cache/" aria-current="page" class="active sidebar-link">4. Stratégie de Cache pour API REST</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fr/4-api-cache/#cache-update-refresh" class="sidebar-link">Cache, Update, Refresh</a></li><li class="sidebar-sub-header"><a href="/fr/4-api-cache/#implementation" class="sidebar-link">Implémentation</a></li><li class="sidebar-sub-header"><a href="/fr/4-api-cache/#rafraichissement-cote-applicatif" class="sidebar-link">Rafraîchissement côté applicatif</a></li><li class="sidebar-sub-header"><a href="/fr/4-api-cache/#test-de-bon-fonctionnement" class="sidebar-link">Test de bon fonctionnement</a></li></ul></li><li><a href="/fr/5-pwa-install/" class="sidebar-link">5. Installation d'une PWA sur le système</a></li><li><a href="/fr/6-background-sync/" class="sidebar-link">6. Background sync et notifications</a></li><li><a href="/fr/finish.html" class="sidebar-link">Pour aller plus loin</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="etape-4-strategie-de-cache-update-refresh-pour-les-requetes-get-de-l-api-rest"><a href="#etape-4-strategie-de-cache-update-refresh-pour-les-requetes-get-de-l-api-rest" class="header-anchor">#</a> Etape 4: Stratégie de Cache/Update/Refresh pour les requêtes GET de l'API REST</h1> <p>Nous avons vu à l'étape précédente comment mettre en cache des fichiers statiques. La stratégie que nous avons mis en place pour ces fichiers est dite <em>Cache-First</em>, c'est-à-dire qu'on servira toujours la version en cache en priorité. Qu'en est-il des données dynamiques, typiquement des réponses d'API ?</p> <p>Pour les besoins du mode offline, il nous faut également mettre ces données dans un cache local. En revanche, contrairement aux fichiers statiques, il est important pour l'utilisateur de disposer des données les plus récentes (les plus &quot;fraîches&quot;), et ce le plus tôt possible. Il nous faut donc changer de stratégie.</p> <h2 id="cache-update-refresh"><a href="#cache-update-refresh" class="header-anchor">#</a> Cache, Update, Refresh</h2> <p>Cette stratégie de cache est légèrement plus complexe mais permet d'utiliser le cache local pour accélérer considérablement le temps de premier chargement, quitte à afficher temporairement des données non à jour.</p> <p>Pour chaque requête, le service Worker va dans un premier temps retourner immédiatement une réponse en cache si elle existe, puis en parallèle requêter le réseau. A la réception de la réponse depuis le réseau, l'entrée en cache sera mise à jour et l'interface utilisateur sera mise à jour automatiquement.</p> <p>Ce rafraichissement de l'interface peut se concrétiser de différentes manières selon les cas. On peut simplement ajouter dynamiquement des éléments à une liste, comme des messages dans une conversation instantanée par exemple. Ou alors notifier l'utilisateur d'une autre manière, par exemple avec un lien proposant de charger le nouveau contenu disponible.</p> <p><img src="/assets/img/schema.688fdb36.png" alt="Schema de fonctionnement"></p> <p>Avantages:</p> <ul><li>Chargement instantané si une réponse est en cache</li> <li>Peut aider à dynamiser l'expérience utilisateur</li></ul> <p>Inconvénients:</p> <ul><li>L'utilisateur ne doit pas pouvoir être en mesure d'interagir avec des données en cours de rafraichissement</li> <li>Le rafraichissement de l'interface à la réception de la réponse réseau peut gêner l'utilisateur si l'UX n'est pas bien pensée</li></ul> <h2 id="implementation"><a href="#implementation" class="header-anchor">#</a> Implémentation</h2> <p>Nous allons pour notre application implémenter cette stratégie de <em>Cache, Update, Refresh</em> pour le chargement de la liste des participants au workshop. Cette liste va probablement peu évoluer entre chaque chargement et la plupart des évolutions successives consisteront en un ajout de un ou plusieurs autres participants. Le rafraichissement à l'écran devrait donc être naturel pour l'utilisateur. Cette stratégie semble donc la plus adaptée dans le cas présent.</p> <h3 id="choix-de-la-strategie-selon-la-requete"><a href="#choix-de-la-strategie-selon-la-requete" class="header-anchor">#</a> Choix de la stratégie selon la requête</h3> <p>Repartons du code du Service Worker, dans le callback d'événement <code>fetch</code>. Nous allons distinguer les requêtes vers notre API des requêtes statiques, afin d'appliquer une stratégie différente pour les données:</p> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;fetch&quot;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;/api/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// réponse aux requêtes API, stratégie Cache Update Refresh</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// réponse aux requêtes de fichiers statiques, stratégie Cache-First</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Toutes nos requêtes vers l'API passent par le même endpoint contenant <code>/api/</code> dans l'URL. On peut donc facilement identifier ces requêtes en se basant sur l'URL accessible depuis <code>event.request.url</code>. Voici la <a href="https://developer.mozilla.org/en-US/docs/Web/API/FetchEvent" target="_blank" rel="noopener noreferrer">documentation de l'API FetchEvent<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h3 id="_1-cache"><a href="#_1-cache" class="header-anchor">#</a> 1. Cache</h3> <p>La première étape est de répondre immédiatement avec la réponse en cache si elle existe. Vous pouvez pour cela réutiliser la fonction <code>caches.match</code> vu à l'étape 3 pour la réponse aux requêtes de ressources statiques.</p> <details class="hidden" data-v-167f501e><summary data-v-167f501e>Voir la solution</summary> <div class="language-js extra-class" data-v-167f501e><pre class="language-js" data-v-167f501e><code data-v-167f501e><span class="token keyword" data-v-167f501e>if</span> <span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>.</span>url<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>includes</span><span class="token punctuation" data-v-167f501e>(</span><span class="token string" data-v-167f501e>&quot;/api/&quot;</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token punctuation" data-v-167f501e>{</span>
    <span class="token comment" data-v-167f501e>// réponse aux requêtes API, stratégie Cache Update Refresh</span>
    event<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>respondWith</span><span class="token punctuation" data-v-167f501e>(</span>caches<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>match</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span>
    <span class="token comment" data-v-167f501e>//TODO: update et refresh</span>
<span class="token punctuation" data-v-167f501e>}</span>
</code></pre></div></details> <h3 id="_2-update"><a href="#_2-update" class="header-anchor">#</a> 2. Update</h3> <p>En parallèle, la requête au réseau doit également être faite avec la méthode <code>fetch(request)</code>, puis on met à jour le cache avec la réponse via la méthode <code>cache.put</code>. Déclarez la fonction <code>update</code> ci-dessous dans le code du Service Worker:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
    <span class="token parameter">response</span> <span class="token operator">=&gt;</span>
      <span class="token function">cache</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token comment">// on peut mettre en cache la réponse</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> response<span class="token punctuation">)</span> <span class="token comment">// résout la promesse avec l'objet Response</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Ensuite, appelez cette fonction <code>update</code> dans le callback de <code>fetch</code> en parallèle de la réponse avec la version en cache. Vous pouvez tout à fait continuer à utiliser l'objet <code>event</code> dans la suite du code même après un premier <code>event.respondWith</code>. Cependant, vous devrez alors utiliser la méthode <code>event.waitUntil()</code> pour étendre la durée de vie de l'événement et indiquer au navigateur que d'autres tâches doivent être effectuées au delà de la réponse initiale.</p> <details class="hidden" data-v-167f501e><summary data-v-167f501e>Voir la solution</summary> <div class="language-js extra-class" data-v-167f501e><pre class="language-js" data-v-167f501e><code data-v-167f501e><span class="token keyword" data-v-167f501e>if</span> <span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>.</span>url<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>includes</span><span class="token punctuation" data-v-167f501e>(</span><span class="token string" data-v-167f501e>&quot;/api/&quot;</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token punctuation" data-v-167f501e>{</span>
  <span class="token comment" data-v-167f501e>// réponse aux requêtes API, stratégie Cache Update Refresh</span>
  event<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>respondWith</span><span class="token punctuation" data-v-167f501e>(</span>caches<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>match</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
  event<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>waitUntil</span><span class="token punctuation" data-v-167f501e>(</span><span class="token function" data-v-167f501e>update</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span> <span class="token comment" data-v-167f501e>//TODO: refresh</span>
<span class="token punctuation" data-v-167f501e>}</span>
</code></pre></div></details> <h3 id="_3-refresh"><a href="#_3-refresh" class="header-anchor">#</a> 3. Refresh</h3> <p>Si le réseau a répondu et que la réponse a été mise en cache, on souhaite indiquer à l'application que de nouvelles données sont disponibles afin d'actualiser l'affichage.</p> <p>Les applications ayant un Service Worker inscrit et installé sont appelés &quot;clients&quot; au regard de ce Service Worker, et sont accessibles via <a href="https://developer.mozilla.org/en-US/docs/Web/API/Clients" target="_blank" rel="noopener noreferrer">l'API <code>Clients</code> documentée ici<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Le Service Worker communique avec le client par le biais de la méthode <code>client.postMessage</code>. Le format d'échange est textuel, vous devrez donc sérialiser vos données en JSON. Le message transmis sera un objet constitué a minima d'une propriété pour identifier le type de message (ici on a choisi l'URL de la requête correspondante) et d'une autre propriété contenant les données à transmettre (le contenu de la réponse).</p> <p>Déclarez la fonction <code>refresh</code> ci-dessous dans le code du Service Worker.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> response
    <span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// lit et parse la réponse JSON</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">jsonResponse</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      self<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">clients</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">client</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// signaler et envoyer au client les nouvelles données</span>
          client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>
            <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              <span class="token literal-property property">type</span><span class="token operator">:</span> response<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
              <span class="token literal-property property">data</span><span class="token operator">:</span> jsonResponse<span class="token punctuation">.</span>data
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> jsonResponse<span class="token punctuation">.</span>data<span class="token punctuation">;</span> <span class="token comment">// résout la promesse avec les nouvelles données</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Il ne reste plus qu'à assembler les 3 blocs <code>cache</code>, <code>update</code> et <code>refresh</code> pour établir la stratégie: la réponse du cache avec un <code>event.respondWith</code>, puis en parallèle l'update suivi du refresh dans un <code>event.waitUntil</code>. La fonction <code>update</code> retourne une <code>Promise</code> résolue avec la réponse réseau, vous pouvez donc la chaîner avec <code>.then()</code> pour exécuter une autre fonction à la suite d'une réponse réseau.</p> <details class="hidden" data-v-167f501e><summary data-v-167f501e>Voir la solution</summary> <div class="language-js extra-class" data-v-167f501e><pre class="language-js" data-v-167f501e><code data-v-167f501e><span class="token keyword" data-v-167f501e>if</span> <span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>.</span>url<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>includes</span><span class="token punctuation" data-v-167f501e>(</span><span class="token string" data-v-167f501e>&quot;/api/&quot;</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span> <span class="token punctuation" data-v-167f501e>{</span>
  <span class="token comment" data-v-167f501e>// réponse aux requêtes API, stratégie Cache Update Refresh</span>
  event<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>respondWith</span><span class="token punctuation" data-v-167f501e>(</span>caches<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>match</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
  event<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>waitUntil</span><span class="token punctuation" data-v-167f501e>(</span><span class="token function" data-v-167f501e>update</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>request<span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>then</span><span class="token punctuation" data-v-167f501e>(</span>refresh<span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
<span class="token punctuation" data-v-167f501e>}</span>
</code></pre></div></details> <h2 id="rafraichissement-cote-applicatif"><a href="#rafraichissement-cote-applicatif" class="header-anchor">#</a> Rafraîchissement côté applicatif</h2> <p>Le client peut écouter les messages émis par le Service Worker via le callback <code>navigator.serviceWorker.onmessage</code>. Vous pouvez ensuite désérialiser le message avec <code>JSON.parse(event.data)</code>. Dans <code>scripts.js</code>, une fois le Service Worker enregistré, déclarez le callback suivant:</p> <div class="language-js extra-class"><pre class="language-js"><code>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//TODO: détecter le type de message et actualiser l'affichage</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>La fonction <code>renderAttendees</code> permet d'actualiser la liste des participants. L'affichage sera donc mis à jour quand le Service Worker enverra le message avec les nouvelles données. Complétez le code ci-dessus en vérifiant si le message correspond à une mise à jour des participants, puis rappelez la fonction <code>renderAttendees</code> avec les données reçues dans le message.</p> <details class="hidden" data-v-167f501e><summary data-v-167f501e>Voir la solution</summary> <div class="language-js extra-class" data-v-167f501e><pre class="language-js" data-v-167f501e><code data-v-167f501e>navigator<span class="token punctuation" data-v-167f501e>.</span>serviceWorker<span class="token punctuation" data-v-167f501e>.</span><span class="token function-variable function" data-v-167f501e>onmessage</span> <span class="token operator" data-v-167f501e>=</span> <span class="token parameter" data-v-167f501e>event</span> <span class="token operator" data-v-167f501e>=&gt;</span> <span class="token punctuation" data-v-167f501e>{</span>
	<span class="token keyword" data-v-167f501e>const</span> message <span class="token operator" data-v-167f501e>=</span> <span class="token constant" data-v-167f501e>JSON</span><span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>parse</span><span class="token punctuation" data-v-167f501e>(</span>event<span class="token punctuation" data-v-167f501e>.</span>data<span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>;</span>
	<span class="token keyword" data-v-167f501e>if</span><span class="token punctuation" data-v-167f501e>(</span>message <span class="token operator" data-v-167f501e>&amp;&amp;</span> message<span class="token punctuation" data-v-167f501e>.</span>type<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>includes</span><span class="token punctuation" data-v-167f501e>(</span><span class="token string" data-v-167f501e>&quot;/api/users&quot;</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>)</span><span class="token punctuation" data-v-167f501e>{</span>
		console<span class="token punctuation" data-v-167f501e>.</span><span class="token function" data-v-167f501e>log</span><span class="token punctuation" data-v-167f501e>(</span><span class="token string" data-v-167f501e>&quot;Liste des participants à jour&quot;</span><span class="token punctuation" data-v-167f501e>,</span> message<span class="token punctuation" data-v-167f501e>.</span>data<span class="token punctuation" data-v-167f501e>)</span>
		<span class="token function" data-v-167f501e>renderAttendees</span><span class="token punctuation" data-v-167f501e>(</span>message<span class="token punctuation" data-v-167f501e>.</span>data<span class="token punctuation" data-v-167f501e>)</span>
	<span class="token punctuation" data-v-167f501e>}</span>
<span class="token punctuation" data-v-167f501e>}</span>
</code></pre></div></details> <h2 id="test-de-bon-fonctionnement"><a href="#test-de-bon-fonctionnement" class="header-anchor">#</a> Test de bon fonctionnement</h2> <p>Pour tester le bon fonctionnement de la stratégie de chargement, puisque l'application utilise pour le moment une API mockup avec de fausses données, nous allons simuler des changements dans le nombre de participants et ajouter une fausse latence réseau pour nous laisser le temps d'observer la stratégie en action.</p> <p>Modifiez la fonction <code>update</code> dans <code>sw.js</code> comme ceci:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">delay</span> <span class="token operator">=</span> <span class="token parameter">ms</span> <span class="token operator">=&gt;</span> <span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// mockup: on charge au hasard entre 1 et 10 participants</span>
	<span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">?per_page=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// on ajoute une fausse latence de 3 secondes</span>
	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>

</code></pre></div><p>Assurez-vous que le Service Worker est bien actualisé et réinstallé (dans les Developer Tools, onglet Application &gt; Service Workers, cochez la case <em>Update on reload</em>, voir étape 2), puis rechargez la page. Vous devriez voir l'ancien nombre de participants, puis 3 secondes plus tard la liste se rafraîchir avec un nouveau nombre de participants.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fr/3-precaching/" class="prev">
        3. Precaching et mode offline basique
      </a></span> <span class="next"><a href="/fr/5-pwa-install/">
        5. Installation d'une PWA sur le système
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1ff487e6.js" defer></script><script src="/assets/js/2.19469b2b.js" defer></script><script src="/assets/js/1.6f1ef934.js" defer></script><script src="/assets/js/34.f672da4a.js" defer></script><script src="/assets/js/23.4035d5be.js" defer></script>
  </body>
</html>
